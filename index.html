<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>漫画コマ枠エディター</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: #333;
    }
    
    .welcome-message {
      text-align: center;
      margin-bottom: 30px;
      color: #555;
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .template-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    
    .template-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .template-thumbnail {
      width: 100%;
      height: 200px;
      background-color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    
    .template-info {
      padding: 15px;
    }
    
    .template-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    
    .template-description {
      font-size: 14px;
      color: #666;
    }

    .thumbnail-placeholder {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
    }

    .thumbnail-panel {
      border: 2px solid #000;
      background-color: #f0f0f0;
      box-sizing: border-box;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .panel-selector {
      display: flex;
      align-items: center;
    }
    
    .panel-selector label {
      margin-right: 10px;
      font-weight: bold;
    }
    
    .image-selector {
      display: flex;
      align-items: center;
    }
    
    .image-selector label {
      margin-right: 10px;
      font-weight: bold;
    }
    
    select {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: white;
      font-size: 16px;
    }
    
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-left: 10px;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    .export-btn {
      background-color: #2196F3;
    }
    
    .export-btn:hover {
      background-color: #0b7dda;
    }

    .back-btn {
      background-color: #f44336;
      margin-right: auto;
    }
    
    .back-btn:hover {
      background-color: #d32f2f;
    }
    
    #loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: white;
      font-size: 18px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .manga-container {
      width: 100%;
      height: 800px;
      background-color: white;
      border: 1px solid #333;
      position: relative;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .panel {
      position: absolute;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border: 2px solid #000;
      box-sizing: border-box;
    }
    
    .panel.selected {
      border: 2px dashed #ff0000;
    }
    
    /* 各パネルの位置とサイズ */
    #panel1 {
      top: 0;
      left: 0;
      width: 40%;
      height: 70%;
    }
    
    #panel2 {
      top: 0;
      left: 40%;
      width: 60%;
      height: 35%;
    }
    
    #panel3 {
      top: 35%;
      left: 40%;
      width: 60%;
      height: 35%;
    }
    
    #panel4 {
      top: 70%;
      left: 0;
      width: 100%;
      height: 30%;
    }
    
    .image-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .preview-item {
      text-align: center;
    }
    
    .preview-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 1px solid #ddd;
      margin-bottom: 5px;
      cursor: pointer;
    }
    
    .preview-image:hover {
      border-color: #4CAF50;
    }

    #template-selection-screen {
      display: block;
    }

    #manga-editor-screen {
      display: none;
    }

    .progress-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 200px;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 5px;
      position: relative;
      z-index: 2;
    }

    .step-circle.active {
      background-color: #4CAF50;
      color: white;
    }

    .step-circle.completed {
      background-color: #4CAF50;
      color: white;
    }

    .step-line {
      width: 100px;
      height: 3px;
      background-color: #ddd;
      position: relative;
      top: -18px;
      z-index: 1;
    }

    .step-line.completed {
      background-color: #4CAF50;
    }

    .step-text {
      font-size: 14px;
      color: #666;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* 全画面のボタンエリア共通スタイル */
    .button-area {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">画像を生成中...</div>
  </div>
  
  <div class="container">
    <h1>漫画コマ枠エディター</h1>

    <!-- 進行状況インジケーター -->
    <div class="progress-bar">
      <div class="progress-step">
        <div class="step-circle active" id="step1">1</div>
        <div class="step-text">テンプレート選択</div>
      </div>
      <div class="step-line" id="line1"></div>
      <div class="progress-step">
        <div class="step-circle" id="step2">2</div>
        <div class="step-text">画像配置</div>
      </div>
      <div class="step-line" id="line2"></div>
      <div class="progress-step">
        <div class="step-circle" id="step3">3</div>
        <div class="step-text">完成・出力</div>
      </div>
    </div>
    
    <!-- テンプレート選択画面 -->
    <div id="template-selection-screen" class="screen active">
      <div class="welcome-message">
        <p>以下から漫画のコマ割りテンプレートを選んでください。</p>
      </div>
      
      <div class="template-grid" id="template-grid">
        <!-- テンプレートはJavaScriptで動的に挿入されます -->
      </div>
    </div>
    
    <!-- 漫画エディター画面 -->
    <div id="manga-editor-screen" class="screen">
      <div class="controls">
        <button id="back-to-templates-btn" class="back-btn">戻る</button>
        
        <div class="panel-selector">
          <label for="panel-select">コマを選択:</label>
          <select id="panel-select">
            <option value="panel1">コマ1</option>
            <option value="panel2">コマ2</option>
            <option value="panel3">コマ3</option>
            <option value="panel4">コマ4</option>
          </select>
        </div>
        
        <div class="image-selector">
          <label for="image-select">画像を選択:</label>
          <select id="image-select">
            <option value="">画像なし</option>
            <option value="1.png">1.png</option>
            <option value="2.png">2.png</option>
            <option value="3.png">3.png</option>
            <option value="4.png">4.png</option>
            <option value="5.png">5.png</option>
          </select>
          <button id="apply-btn">適用</button>
          <button id="reset-btn">リセット</button>
          <button id="export-btn" class="export-btn">PNG出力</button>
        </div>
      </div>
      
      <div class="manga-container" id="manga-container">
        <!-- パネルはJavaScriptで動的に挿入されます -->
      </div>
      
      <div class="image-preview">
        <div class="preview-item">
          <img src="/api/placeholder/100/100" alt="1.png" class="preview-image" data-image="1.png">
          <div>1.png</div>
        </div>
        <div class="preview-item">
          <img src="/api/placeholder/100/100" alt="2.png" class="preview-image" data-image="2.png">
          <div>2.png</div>
        </div>
        <div class="preview-item">
          <img src="/api/placeholder/100/100" alt="3.png" class="preview-image" data-image="3.png">
          <div>3.png</div>
        </div>
        <div class="preview-item">
          <img src="/api/placeholder/100/100" alt="4.png" class="preview-image" data-image="4.png">
          <div>4.png</div>
        </div>
        <div class="preview-item">
          <img src="/api/placeholder/100/100" alt="5.png" class="preview-image" data-image="5.png">
          <div>5.png</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 状態管理
      let currentStep = 1;
      let currentTemplate = null;
      let currentPanel = null;

      // 要素の取得
      const templateSelectionScreen = document.getElementById('template-selection-screen');
      const mangaEditorScreen = document.getElementById('manga-editor-screen');
      const templateGrid = document.getElementById('template-grid');
      const mangaContainer = document.getElementById('manga-container');
      const panelSelect = document.getElementById('panel-select');
      const imageSelect = document.getElementById('image-select');
      const applyBtn = document.getElementById('apply-btn');
      const resetBtn = document.getElementById('reset-btn');
      const exportBtn = document.getElementById('export-btn');
      const backToTemplatesBtn = document.getElementById('back-to-templates-btn');
      const loadingOverlay = document.getElementById('loading-overlay');
      
      // 進行状況要素
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const line1 = document.getElementById('line1');
      const line2 = document.getElementById('line2');

      // テンプレートデータの読み込み
      fetch('templates/templates.json')
        .then(response => response.json())
        .then(data => {
          // テンプレートカードの作成
          data.templates.forEach(template => {
            const templateCard = document.createElement('div');
            templateCard.className = 'template-card';
            templateCard.dataset.templateId = template.id;
            
            // サムネイルがない場合の代替表示
            const thumbnailHTML = `
              <div class="template-thumbnail">
                <div class="thumbnail-placeholder">
                  <div class="thumbnail-panel"></div>
                  <div class="thumbnail-panel"></div>
                  <div class="thumbnail-panel"></div>
                  <div class="thumbnail-panel"></div>
                </div>
              </div>
            `;
            
            templateCard.innerHTML = `
              ${thumbnailHTML}
              <div class="template-info">
                <div class="template-title">${template.title}</div>
                <div class="template-description">${template.description}</div>
              </div>
            `;
            
            // テンプレートクリック時の処理
            templateCard.addEventListener('click', () => {
              loadTemplate(template.id);
            });
            
            templateGrid.appendChild(templateCard);
          });
        })
        .catch(error => {
          console.error('テンプレートの読み込みに失敗しました:', error);
          alert('テンプレートの読み込みに失敗しました。詳細はコンソールを確認してください。');
        });

      // テンプレート読み込み処理
      function loadTemplate(templateId) {
        fetch(`templates/${templateId}.json`)
          .then(response => response.json())
          .then(template => {
            // テンプレートを保存
            currentTemplate = template;
            
            // ステップ更新
            updateStep(2);
            
            // 漫画コンテナをクリア
            mangaContainer.innerHTML = '';
            
            // パネルの作成
            template.panels.forEach(panel => {
              const panelElement = document.createElement('div');
              panelElement.id = panel.id;
              panelElement.className = 'panel';
              panelElement.style.top = `${panel.top}%`;
              panelElement.style.left = `${panel.left}%`;
              panelElement.style.width = `${panel.width}%`;
              panelElement.style.height = `${panel.height}%`;
              
              // パネルクリック時の処理を追加
              panelElement.addEventListener('click', function() {
                selectPanel(this);
              });
              
              mangaContainer.appendChild(panelElement);
            });
            
            // 最初のパネルを選択
            currentPanel = document.getElementById('panel1');
            currentPanel.classList.add('selected');
            
            // 画面切り替え
            templateSelectionScreen.classList.remove('active');
            mangaEditorScreen.classList.add('active');
          })
          .catch(error => {
            console.error('テンプレートの読み込みに失敗しました:', error);
            alert('テンプレートの読み込みに失敗しました。詳細はコンソールを確認してください。');
          });
      }

      // パネル選択処理
      function selectPanel(panel) {
        if (currentPanel) {
          currentPanel.classList.remove('selected');
        }
        
        currentPanel = panel;
        currentPanel.classList.add('selected');
        
        // セレクトボックスの値を更新
        panelSelect.value = currentPanel.id;
        
        // 背景画像があれば、その画像をセレクトボックスで選択
        const backgroundImage = currentPanel.style.backgroundImage;
        if (backgroundImage) {
          const imageName = backgroundImage.split('/').pop().replace('")', '');
          imageSelect.value = imageName;
        } else {
          imageSelect.value = '';
        }
      }

      // ステップ更新処理
      function updateStep(step) {
        currentStep = step;
        
        // すべてのステップをリセット
        step1.classList.remove('active', 'completed');
        step2.classList.remove('active', 'completed');
        step3.classList.remove('active', 'completed');
        line1.classList.remove('completed');
        line2.classList.remove('completed');
        
        // 現在のステップまで更新
        if (step >= 1) {
          step1.classList.add(step > 1 ? 'completed' : 'active');
        }
        
        if (step >= 2) {
          line1.classList.add('completed');
          step2.classList.add(step > 2 ? 'completed' : 'active');
        }
        
        if (step >= 3) {
          line2.classList.add('completed');
          step3.classList.add('active');
        }
      }

      // テンプレート選択に戻るボタンの処理
      backToTemplatesBtn.addEventListener('click', function() {
        updateStep(1);
        mangaEditorScreen.classList.remove('active');
        templateSelectionScreen.classList.add('active');
      });

      // パネル選択時の処理
      panelSelect.addEventListener('change', function() {
        // 現在の選択を解除
        if (currentPanel) {
          currentPanel.classList.remove('selected');
        }
        
        // 新しいパネルを選択
        const panelId = this.value;
        currentPanel = document.getElementById(panelId);
        currentPanel.classList.add('selected');
        
        // 選択されているパネルの背景画像があれば、その画像をセレクトボックスで選択
        const backgroundImage = currentPanel.style.backgroundImage;
        if (backgroundImage) {
          const imageName = backgroundImage.split('/').pop().replace('")', '');
          imageSelect.value = imageName;
        } else {
          imageSelect.value = '';
        }
      });
      
      // 画像適用ボタンの処理
      applyBtn.addEventListener('click', function() {
        const selectedImage = imageSelect.value;
        if (selectedImage) {
          currentPanel.style.backgroundImage = `url(${selectedImage})`;
        } else {
          currentPanel.style.backgroundImage = 'none';
        }
        
        // すべてのパネルに画像が設定されているか確認
        const panels = document.querySelectorAll('.panel');
        let allPanelsHaveImages = true;
        
        panels.forEach(panel => {
          if (!panel.style.backgroundImage || panel.style.backgroundImage === 'none') {
            allPanelsHaveImages = false;
          }
        });
        
        // すべてのパネルに画像が設定されていれば次のステップに進む
        if (allPanelsHaveImages) {
          updateStep(3);
        }
      });
      
      // リセットボタンの処理
      resetBtn.addEventListener('click', function() {
        const panels = document.querySelectorAll('.panel');
        panels.forEach(panel => {
          panel.style.backgroundImage = 'none';
        });
        imageSelect.value = '';
        updateStep(2); // ステップを2に戻す
      });
      
      // プレビュー画像クリック時の処理
      const previewImages = document.querySelectorAll('.preview-image');
      previewImages.forEach(img => {
        img.addEventListener('click', function() {
          const imageName = this.dataset.image;
          imageSelect.value = imageName;
          if (currentPanel) {
            currentPanel.style.backgroundImage = `url(${imageName})`;
            
            // すべてのパネルに画像が設定されているか確認
            const panels = document.querySelectorAll('.panel');
            let allPanelsHaveImages = true;
            
            panels.forEach(panel => {
              if (!panel.style.backgroundImage || panel.style.backgroundImage === 'none') {
                allPanelsHaveImages = false;
              }
            });
            
            // すべてのパネルに画像が設定されていれば次のステップに進む
            if (allPanelsHaveImages) {
              updateStep(3);
            }
          }
        });
      });
      
      // PNG出力ボタンの処理
      exportBtn.addEventListener('click', function() {
        // ローディングオーバーレイを表示
        loadingOverlay.style.display = 'flex';
        
        // 少し遅延させてUIの更新を確実に
        setTimeout(() => {
          // 選択クラスを一時的に削除
          if (currentPanel) {
            currentPanel.classList.remove('selected');
          }
          
          // html2canvasを使用して漫画コンテナをキャプチャ
          html2canvas(mangaContainer, {
            backgroundColor: "#ffffff",
            scale: 2, // 高解像度化
            logging: false,
            useCORS: true, // 画像読み込みのためのCORS対応
          }).then(canvas => {
            // 選択クラスを戻す
            if (currentPanel) {
              currentPanel.classList.add('selected');
            }
            
            // canvasをPNG形式に変換
            const imgData = canvas.toDataURL('image/png');
            
            // ダウンロードリンクを作成
            const link = document.createElement('a');
            link.href = imgData;
            const templateTitle = currentTemplate ? currentTemplate.title : '漫画';
            link.download = `${templateTitle}-` + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.png';
            
            // リンクをクリックしてダウンロード開始
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // ローディングオーバーレイを非表示
            loadingOverlay.style.display = 'none';
          }).catch(error => {
            console.error('画像の出力に失敗しました:', error);
            alert('画像の出力に失敗しました。詳細はコンソールを確認してください。');
            loadingOverlay.style.display = 'none';
          });
        }, 100);
      });
    });
  </script>
</body>
</html>