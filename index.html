<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>漫画コマ枠エディター</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: #333;
    }
    
    .welcome-message {
      text-align: center;
      margin-bottom: 30px;
      color: #555;
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .template-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    
    .template-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .template-thumbnail {
      width: 100%;
      height: 200px;
      background-color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    
    .template-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .template-thumbnail img:hover {
      transform: scale(1.05);
    }
    
    .template-info {
      padding: 15px;
    }
    
    .template-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    
    .template-description {
      font-size: 14px;
      color: #666;
    }

    .thumbnail-placeholder {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 2px;
    }

    .thumbnail-panel {
      border: 2px solid #000;
      background-color: #f0f0f0;
      box-sizing: border-box;
      min-height: 10px;
      min-width: 10px;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .panel-selector {
      display: flex;
      align-items: center;
    }
    
    .panel-selector label {
      margin-right: 10px;
      font-weight: bold;
    }
    
    .image-selector {
      display: flex;
      align-items: center;
    }
    
    .image-selector label {
      margin-right: 10px;
      font-weight: bold;
    }
    
    select {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background-color: white;
      font-size: 16px;
    }
    
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-left: 10px;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    .export-btn {
      background-color: #2196F3;
    }
    
    .export-btn:hover {
      background-color: #0b7dda;
    }

    .back-btn {
      background-color: #f44336;
      margin-right: auto;
    }
    
    .back-btn:hover {
      background-color: #d32f2f;
    }
    
    #loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: white;
      font-size: 18px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .manga-container {
      width: 100%;
      max-width: 800px;
      height: auto;
      aspect-ratio: 1;
      background-color: white;
      border: 1px solid #333;
      position: relative;
      margin: 0 auto 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
      overflow: hidden;
    }
    
    .panel {
      position: absolute;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border: 1px solid #000;
      box-sizing: border-box;
      overflow: hidden;
      background-color: #f5f5f5;
    }
    
    .panel.selected {
      border: 2px dashed #ff0000;
    }

    /* 台形などの特殊形状のコマの境界線用スタイル */
    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 1px solid #000;
      pointer-events: none;
      clip-path: inherit;
      z-index: 2;
    }
    
    .panel.selected::before {
      border: 2px dashed #ff0000;
    }

    /* 各コマの色分け用スタイル */
    .panel[id="panel1"] {
      background-color: #e3f2fd; /* 薄い青 */
    }
    
    .panel[id="panel2"] {
      background-color: #e8f5e9; /* 薄い緑 */
    }
    
    .panel[id="panel3"] {
      background-color: #fff3e0; /* 薄いオレンジ */
    }
    
    .panel[id="panel4"] {
      background-color: #f3e5f5; /* 薄い紫 */
    }
    
    /* 各パネルの位置とサイズ */
    #panel1 {
      top: 0;
      left: 0;
      width: 40%;
      height: 70%;
    }
    
    #panel2 {
      top: 0;
      left: 40%;
      width: 60%;
      height: 35%;
    }
    
    #panel3 {
      top: 35%;
      left: 40%;
      width: 60%;
      height: 35%;
    }
    
    #panel4 {
      top: 70%;
      left: 0;
      width: 100%;
      height: 30%;
    }
    
    .image-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .preview-item {
      text-align: center;
    }
    
    .preview-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 1px solid #ddd;
      margin-bottom: 5px;
      cursor: pointer;
    }
    
    .preview-image:hover {
      border-color: #4CAF50;
    }

    #template-selection-screen.active {
      display: block;
    }

    #template-selection-screen:not(.active) {
      display: none;
    }

    #manga-editor-screen.active {
      display: block;
    }

    #manga-editor-screen:not(.active) {
      display: none;
    }

    .progress-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 200px;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 5px;
      position: relative;
      z-index: 2;
    }

    .step-circle.active {
      background-color: #4CAF50;
      color: white;
    }

    .step-circle.completed {
      background-color: #4CAF50;
      color: white;
    }

    .step-line {
      width: 100px;
      height: 3px;
      background-color: #ddd;
      position: relative;
      top: -18px;
      z-index: 1;
    }

    .step-line.completed {
      background-color: #4CAF50;
    }

    .step-text {
      font-size: 14px;
      color: #666;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* 全画面のボタンエリア共通スタイル */
    .button-area {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* テンプレートプレビュースタイル */
    .template-preview-template1 {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    .template-preview-template2 {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr 1fr 1fr 1fr;
    }

    .template-preview-template3 .thumbnail-panel:first-child {
      grid-row: span 3;
      grid-column: 1;
    }
    .template-preview-template3 .thumbnail-panel:nth-child(2),
    .template-preview-template3 .thumbnail-panel:nth-child(3),
    .template-preview-template3 .thumbnail-panel:nth-child(4) {
      grid-column: 2;
    }

    .template-preview-template4 .thumbnail-panel:first-child {
      grid-row: span 2;
      grid-column: 1;
    }
    .template-preview-template4 .thumbnail-panel:nth-child(2),
    .template-preview-template4 .thumbnail-panel:nth-child(3) {
      grid-column: 2;
    }
    .template-preview-template4 .thumbnail-panel:nth-child(4) {
      grid-column: span 2;
    }

    .template-preview-template5 {
      grid-template-columns: 1fr 1fr 1fr 1fr;
      grid-template-rows: 1fr;
    }

    .template-preview-template6 .thumbnail-panel:nth-child(odd) {
      margin-right: 25%;
    }
    .template-preview-template6 .thumbnail-panel:nth-child(even) {
      margin-left: 25%;
    }

    .template-preview-template7 .thumbnail-panel:first-child {
      grid-column: span 3;
    }
    .template-preview-template7 .thumbnail-panel:nth-child(2),
    .template-preview-template7 .thumbnail-panel:nth-child(3),
    .template-preview-template7 .thumbnail-panel:nth-child(4) {
      grid-row: 2;
    }

    .template-preview-template8 .thumbnail-panel:first-child,
    .template-preview-template8 .thumbnail-panel:nth-child(2) {
      grid-row: 1;
    }
    .template-preview-template8 .thumbnail-panel:nth-child(3),
    .template-preview-template8 .thumbnail-panel:nth-child(4) {
      grid-row: 2;
    }

    .template-preview-template9 .thumbnail-panel:nth-child(2) {
      grid-row: span 2;
      grid-column: 2;
    }
    .template-preview-template9 .thumbnail-panel:nth-child(4) {
      grid-column: span 2;
    }

    .template-preview-template10 .thumbnail-panel:first-child {
      grid-column: 2;
      grid-row: 1;
    }
    .template-preview-template10 .thumbnail-panel:nth-child(2) {
      grid-column: 1;
      grid-row: 2;
    }
    .template-preview-template10 .thumbnail-panel:nth-child(3) {
      grid-column: 2;
      grid-row: 2;
    }
    .template-preview-template10 .thumbnail-panel:nth-child(4) {
      grid-column: 3;
      grid-row: 2;
    }

    /* テンプレート情報表示エリア */
    .template-header {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .template-header h2 {
      margin: 0 0 5px 0;
      color: #333;
      font-size: 20px;
    }

    .template-header p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">画像を生成中...</div>
    <div class="process-status" style="color:white; margin-top:10px; font-size:14px;"></div>
  </div>
  
  <div class="container">
    <h1>漫画コマ枠エディター</h1>
    
    <!-- 進行状況インジケーター -->
    <div class="progress-bar">
      <div class="progress-step">
        <div class="step-circle active" id="step1">1</div>
        <div class="step-text">テンプレート選択</div>
      </div>
      <div class="step-line" id="line1"></div>
      <div class="progress-step">
        <div class="step-circle" id="step2">2</div>
        <div class="step-text">画像配置</div>
      </div>
      <div class="step-line" id="line2"></div>
      <div class="progress-step">
        <div class="step-circle" id="step3">3</div>
        <div class="step-text">完成・出力</div>
      </div>
    </div>
    
    <!-- テンプレート選択画面 -->
    <div id="template-selection-screen" class="screen active">
      <div class="welcome-message">
        <p>以下から漫画のコマ割りテンプレートを選んでください。</p>
      </div>
      
      <div class="template-grid" id="template-grid">
        <!-- テンプレートはJavaScriptで動的に挿入されます -->
      </div>
    </div>
    
    <!-- 漫画エディター画面 -->
    <div id="manga-editor-screen" class="screen">
    <div class="controls">
        <button id="back-to-templates-btn" class="back-btn">戻る</button>
        
      <div class="panel-selector">
        <label for="panel-select">コマを選択:</label>
        <select id="panel-select">
            <option value="panel1">コマ1</option>
            <option value="panel2">コマ2</option>
            <option value="panel3">コマ3</option>
            <option value="panel4">コマ4</option>
        </select>
      </div>
      
      <div class="image-selector">
        <label for="image-select">画像を選択:</label>
        <select id="image-select">
          <option value="">画像なし</option>
          <option value="1.png">1.png</option>
          <option value="2.png">2.png</option>
          <option value="3.png">3.png</option>
          <option value="4.png">4.png</option>
          <option value="5.png">5.png</option>
        </select>
        <button id="apply-btn">適用</button>
        <button id="reset-btn">リセット</button>
        <button id="export-btn" class="export-btn">SVG保存</button>
        <button id="export-svg-btn" style="background-color: #FF9800; display: none;">SVG保存</button>
      </div>
    </div>
    
      <!-- テンプレート情報 -->
      <div class="template-header" id="template-header">
        <h2>テンプレート名</h2>
        <p>テンプレートの説明</p>
      </div>
      
      <div class="manga-container" id="manga-container">
        <!-- パネルはJavaScriptで動的に挿入されます -->
    </div>
    
    <div class="image-preview">
      <div class="preview-item">
          <img src="1.png" alt="1.png" class="preview-image" data-image="1.png" crossorigin="anonymous">
        <div>1.png</div>
      </div>
      <div class="preview-item">
          <img src="2.png" alt="2.png" class="preview-image" data-image="2.png" crossorigin="anonymous">
        <div>2.png</div>
      </div>
      <div class="preview-item">
          <img src="3.png" alt="3.png" class="preview-image" data-image="3.png" crossorigin="anonymous">
        <div>3.png</div>
      </div>
      <div class="preview-item">
          <img src="4.png" alt="4.png" class="preview-image" data-image="4.png" crossorigin="anonymous">
        <div>4.png</div>
      </div>
      <div class="preview-item">
          <img src="5.png" alt="5.png" class="preview-image" data-image="5.png" crossorigin="anonymous">
        <div>5.png</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // グローバル変数として必要なAPIを定義（ブラウザサポート用）
    window.createObjectURL = (window.URL || window.webkitURL || {}).createObjectURL || function(){};
    window.Blob = window.Blob || function(){};

    document.addEventListener('DOMContentLoaded', function() {
      // 状態管理
      let currentStep = 1;
      let currentTemplate = null;
      let currentPanel = null;
      
      // 画像プリロード
      const preloadImages = ['1.png', '2.png', '3.png', '4.png', '5.png'];
      const imageCache = {};
      
      // 画像をプリロード
      preloadImages.forEach(src => {
        const img = new Image();
        img.crossOrigin = "anonymous"; // CORS対応を追加
        
        // フルパスに変換して保存しておく関数
        const saveFullPath = () => {
          // キャッシュに画像を保存
          imageCache[src] = img;
          
          // 絶対URLをキャッシュに保存
          if (img.src.startsWith('http') || img.src.startsWith('data:')) {
            imageCache[src + '_fullpath'] = img.src;
            console.log(`画像の絶対パスをキャッシュ: ${src} -> ${img.src}`);
          }
        };
        
        img.onload = () => {
          console.log(`画像プリロード完了: ${src}`);
          saveFullPath();
        };
        
        img.onerror = () => {
          console.error(`画像プリロード失敗: ${src}、相対パスを試します`);
          // ローカルでの開発時のフォールバック
          if (!img.src.startsWith('./')) {
            img.src = './' + src;
          } else {
            console.error(`画像ロード最終失敗: ${src}`);
          }
        };
        
        // 絶対URLの場合は直接、そうでなければVarcelのドメインからの相対パスを試す
        if (window.location.hostname.includes('vercel.app')) {
          // Vercel環境では完全なURLを構築
          const baseUrl = window.location.origin;
          img.src = `${baseUrl}/${src}`;
          console.log(`Vercel環境での画像パス: ${img.src}`);
        } else {
          // ローカル環境など
          img.src = src;
        }
      });
      
      // 要素の取得
      const templateSelectionScreen = document.getElementById('template-selection-screen');
      const mangaEditorScreen = document.getElementById('manga-editor-screen');
      const templateGrid = document.getElementById('template-grid');
      const mangaContainer = document.getElementById('manga-container');
      const panelSelect = document.getElementById('panel-select');
      const imageSelect = document.getElementById('image-select');
      const applyBtn = document.getElementById('apply-btn');
      const resetBtn = document.getElementById('reset-btn');
      const exportBtn = document.getElementById('export-btn');
      const exportSvgBtn = document.getElementById('export-svg-btn');
      const backToTemplatesBtn = document.getElementById('back-to-templates-btn');
      const loadingOverlay = document.getElementById('loading-overlay');
      
      // 進行状況要素
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const line1 = document.getElementById('line1');
      const line2 = document.getElementById('line2');

      // テンプレート定義を保持するオブジェクト
      let templateDefinitions = {};

      // テンプレートデータをJSONファイルから読み込む
      async function loadTemplatesData() {
        try {
          // テンプレート一覧を読み込む
          const response = await fetch('templates/templates.json');
          if (!response.ok) {
            throw new Error('テンプレート一覧の読み込みに失敗しました');
          }
          const templatesData = await response.json();
          console.log('テンプレート一覧を読み込みました:', templatesData);
          
          // テンプレートカードを作成
          displayTemplateCards(templatesData);
          
          // 各テンプレートの詳細を読み込む
          await loadTemplateDefinitions(templatesData.templates);
          
          console.log('全テンプレート定義の読み込みが完了しました');
        } catch (error) {
          console.error('テンプレートの読み込み中にエラーが発生しました:', error);
          alert('テンプレートの読み込みに失敗しました。デフォルトのテンプレートを使用します。');
          // デフォルトのテンプレートを使用
          const defaultTemplatesData = {
            "templates": [
              {
                "id": "template1",
                "title": "標準4コマ",
                "description": "標準的な上下2段の4コマレイアウト",
                "thumbnail": "thumbnails/template1.png"
              }
            ]
          };
          displayTemplateCards(defaultTemplatesData);
        }
      }
      
      // テンプレート定義を読み込む
      async function loadTemplateDefinitions(templates) {
        const promises = templates.map(async (template) => {
          try {
            const response = await fetch(`templates/${template.id}.json`);
            if (!response.ok) {
              throw new Error(`テンプレート ${template.id} の読み込みに失敗しました`);
            }
            const templateData = await response.json();
            templateDefinitions[template.id] = templateData;
            console.log(`テンプレート ${template.id} を読み込みました:`, templateData);
          } catch (error) {
            console.error(`テンプレート ${template.id} の読み込み中にエラーが発生しました:`, error);
          }
        });
        
        // すべてのテンプレート読み込みを待機
        await Promise.all(promises);
      }
      
      // テンプレートカードを表示
      function displayTemplateCards(templatesData) {
        templateGrid.innerHTML = ''; // グリッドをクリア
        console.log('テンプレート一覧を表示します');
        
        // テンプレートカードの作成
        templatesData.templates.forEach(template => {
          const templateCard = document.createElement('div');
          templateCard.className = 'template-card';
          templateCard.dataset.templateId = template.id;
          
          // サムネイルがない場合の代替表示
          const thumbnailHTML = `
            <div class="template-thumbnail">
              <img src="${template.id <= 5 ? template.id + '.png' : 'thumbnails/' + template.id.replace('template', '') + '.png'}" 
                   alt="${template.title}" 
                   style="max-width: 100%; max-height: 100%; object-fit: cover;">
            </div>
          `;
          
          templateCard.innerHTML = `
            ${thumbnailHTML}
            <div class="template-info">
              <div class="template-title">${template.title}</div>
              <div class="template-description">${template.description}</div>
            </div>
          `;
          
          // テンプレートクリック時の処理
          templateCard.addEventListener('click', () => {
            console.log('テンプレートカードがクリックされました:', template.id);
            try {
              loadTemplateFromDefinition(template.id);
            } catch (error) {
              console.error('テンプレート読み込み中にエラーが発生しました:', error);
              alert('テンプレートの読み込みに失敗しました。デフォルトテンプレートを使用します。');
              useDefaultTemplate();
            }
          });
          
          templateGrid.appendChild(templateCard);
        });
      }

      // 初期化処理：テンプレートを読み込む
      loadTemplatesData();

      // インラインテンプレートから読み込む処理
      function loadTemplateFromDefinition(templateId) {
        console.log('テンプレート読み込み開始:', templateId);
        
        if (templateDefinitions[templateId]) {
          const template = templateDefinitions[templateId];
          console.log('読み込んだテンプレート:', template);
          
          // テンプレートを保存
          currentTemplate = template;
          
          // ステップ更新
          updateStep(2);
          
          // 漫画コンテナをクリア
          mangaContainer.innerHTML = '';
          
          // テンプレート情報をヘッダーに表示
          const templateHeader = document.getElementById('template-header');
          templateHeader.innerHTML = `
            <h2>${template.title}</h2>
            <p>${template.description}</p>
          `;
          
          // パネルの作成
          template.panels.forEach(panel => {
            const panelElement = document.createElement('div');
            panelElement.id = panel.id;
            panelElement.className = 'panel';
            panelElement.style.top = `${panel.top}%`;
            panelElement.style.left = `${panel.left}%`;
            panelElement.style.width = `${panel.width}%`;
            panelElement.style.height = `${panel.height}%`;
            panelElement.style.backgroundSize = 'cover';
            panelElement.style.backgroundPosition = 'center';
            
            // clipPathがある場合は適用
            if (panel.clipPath) {
              panelElement.style.clipPath = panel.clipPath;
              // 背景色は各パネルIDに基づいて自動的に設定されます（CSS側）
            }
            
            // 位置情報をデータ属性として保存
            panelElement.dataset.top = `${panel.top}%`;
            panelElement.dataset.left = `${panel.left}%`;
            panelElement.dataset.width = `${panel.width}%`;
            panelElement.dataset.height = `${panel.height}%`;
            
            // パネルクリック時の処理を追加
            panelElement.addEventListener('click', function() {
              selectPanel(this);
            });
            
            mangaContainer.appendChild(panelElement);
          });
          
          // 最初のパネルを選択
          currentPanel = document.getElementById('panel1');
          currentPanel.classList.add('selected');
          
          // 画面切り替え
          templateSelectionScreen.classList.remove('active');
          mangaEditorScreen.classList.add('active');
          
          // 強制的な表示/非表示の設定
          templateSelectionScreen.style.display = 'none';
          mangaEditorScreen.style.display = 'block';
        } else {
          console.error(`テンプレート ${templateId} が見つかりません`);
          alert(`テンプレート ${templateId} が見つかりません。デフォルトテンプレートを使用します。`);
          useDefaultTemplate();
        }
      }

      // デフォルトテンプレートを使用する関数
      async function useDefaultTemplate() {
        try {
          // 標準的な4コマ漫画レイアウトのテンプレートをファイルから読み込む
          const response = await fetch('templates/template1.json');
          if (!response.ok) {
            throw new Error('デフォルトテンプレートの読み込みに失敗しました');
          }
          
          const defaultTemplateData = await response.json();
          console.log('デフォルトテンプレートを読み込みました:', defaultTemplateData);
          
          // テンプレートを保存
          currentTemplate = defaultTemplateData;
          
          // ステップ更新
          updateStep(2);
          
          // 漫画コンテナをクリア
          mangaContainer.innerHTML = '';
          
          // テンプレート情報をヘッダーに表示
          const templateHeader = document.getElementById('template-header');
          templateHeader.innerHTML = `
            <h2>${defaultTemplateData.title}</h2>
            <p>${defaultTemplateData.description}</p>
          `;
          
          // パネルの作成
          defaultTemplateData.panels.forEach(panel => {
            const panelElement = document.createElement('div');
            panelElement.id = panel.id;
            panelElement.className = 'panel';
            panelElement.style.top = `${panel.top}%`;
            panelElement.style.left = `${panel.left}%`;
            panelElement.style.width = `${panel.width}%`;
            panelElement.style.height = `${panel.height}%`;
            panelElement.style.backgroundSize = 'cover';
            panelElement.style.backgroundPosition = 'center';
            
            // clipPathがある場合は適用
            if (panel.clipPath) {
              panelElement.style.clipPath = panel.clipPath;
              // 背景色は各パネルIDに基づいて自動的に設定されます（CSS側）
            }
            
            // 位置情報をデータ属性として保存
            panelElement.dataset.top = `${panel.top}%`;
            panelElement.dataset.left = `${panel.left}%`;
            panelElement.dataset.width = `${panel.width}%`;
            panelElement.dataset.height = `${panel.height}%`;
            
            // パネルクリック時の処理を追加
            panelElement.addEventListener('click', function() {
              selectPanel(this);
            });
            
            mangaContainer.appendChild(panelElement);
          });
          
          // 最初のパネルを選択
          currentPanel = document.getElementById('panel1');
          currentPanel.classList.add('selected');
          
          // 画面切り替え
          templateSelectionScreen.classList.remove('active');
          mangaEditorScreen.classList.add('active');
          
          // 強制的な表示/非表示の設定
          templateSelectionScreen.style.display = 'none';
          mangaEditorScreen.style.display = 'block';
        } catch (error) {
          console.error('デフォルトテンプレート読み込み中にエラーが発生しました:', error);
          
          // ハードコードされたフォールバックテンプレート
          const fallbackTemplateData = {
            title: "標準4コマ（フォールバック）",
            description: "標準的な上下2段の4コマレイアウト",
            panels: [
              { id: "panel1", top: 0, left: 0, width: 50, height: 50 },
              { id: "panel2", top: 0, left: 50, width: 50, height: 50 },
              { id: "panel3", top: 50, left: 0, width: 50, height: 50 },
              { id: "panel4", top: 50, left: 50, width: 50, height: 50 }
            ]
          };
          
          currentTemplate = fallbackTemplateData;
          updateStep(2);
          
          // テンプレート情報をヘッダーに表示
          const templateHeader = document.getElementById('template-header');
          templateHeader.innerHTML = `
            <h2>${fallbackTemplateData.title}</h2>
            <p>${fallbackTemplateData.description}</p>
          `;
          
          // 残りのコードは同じ...
          mangaContainer.innerHTML = '';
          
          fallbackTemplateData.panels.forEach(panel => {
            const panelElement = document.createElement('div');
            panelElement.id = panel.id;
            panelElement.className = 'panel';
            panelElement.style.top = `${panel.top}%`;
            panelElement.style.left = `${panel.left}%`;
            panelElement.style.width = `${panel.width}%`;
            panelElement.style.height = `${panel.height}%`;
            panelElement.style.backgroundSize = 'cover';
            panelElement.style.backgroundPosition = 'center';
            
            // clipPathがある場合は適用
            if (panel.clipPath) {
              panelElement.style.clipPath = panel.clipPath;
              // 背景色は各パネルIDに基づいて自動的に設定されます（CSS側）
            }
            
            panelElement.dataset.top = `${panel.top}%`;
            panelElement.dataset.left = `${panel.left}%`;
            panelElement.dataset.width = `${panel.width}%`;
            panelElement.dataset.height = `${panel.height}%`;
            
            panelElement.addEventListener('click', function() {
              selectPanel(this);
            });
            
            mangaContainer.appendChild(panelElement);
          });
          
          currentPanel = document.getElementById('panel1');
          currentPanel.classList.add('selected');
          
          templateSelectionScreen.classList.remove('active');
          mangaEditorScreen.classList.add('active');
          
          templateSelectionScreen.style.display = 'none';
          mangaEditorScreen.style.display = 'block';
        }
      }

      // パネル選択処理
      function selectPanel(panel) {
        if (currentPanel) {
          currentPanel.classList.remove('selected');
          // 通常の枠線に戻す
          currentPanel.style.border = '1px solid #000';
        }
        
        currentPanel = panel;
        currentPanel.classList.add('selected');
        // 赤い点線の枠線に変更
        currentPanel.style.border = '2px dashed #ff0000';
        
        // セレクトボックスの値を更新
        panelSelect.value = currentPanel.id;
        
        // 画像があればそれをセレクトボックスで選択
        if (currentPanel.style.backgroundImage && currentPanel.style.backgroundImage !== 'none') {
          // 背景画像からファイル名を抽出
          const bgImageUrl = currentPanel.style.backgroundImage;
          const match = bgImageUrl.match(/url\(['"]?([^'"]+)['"]?\)/i);
          if (match && match[1]) {
            const imagePath = match[1];
            const imageName = imagePath.substring(imagePath.lastIndexOf('/') + 1);
            imageSelect.value = imageName;
          } else {
            imageSelect.value = '';
          }
        } else {
          imageSelect.value = '';
        }
      }
      
      // パネル選択時の処理
      panelSelect.addEventListener('change', function() {
        // 現在の選択を解除
        if (currentPanel) {
        currentPanel.classList.remove('selected');
          // 通常の枠線に戻す
          currentPanel.style.border = '1px solid #000';
        }
        
        // 新しいパネルを選択
        const panelId = this.value;
        currentPanel = document.getElementById(panelId);
        currentPanel.classList.add('selected');
        // 赤い点線の枠線に変更
        currentPanel.style.border = '2px dashed #ff0000';
        
        // 画像があればそれをセレクトボックスで選択
        if (currentPanel.style.backgroundImage && currentPanel.style.backgroundImage !== 'none') {
          // 背景画像からファイル名を抽出
          const bgImageUrl = currentPanel.style.backgroundImage;
          const match = bgImageUrl.match(/url\(['"]?([^'"]+)['"]?\)/i);
          if (match && match[1]) {
            const imagePath = match[1];
            const imageName = imagePath.substring(imagePath.lastIndexOf('/') + 1);
          imageSelect.value = imageName;
          } else {
            imageSelect.value = '';
          }
        } else {
          imageSelect.value = '';
        }
      });

      // ステップ更新処理
      function updateStep(step) {
        currentStep = step;
        
        // すべてのステップをリセット
        step1.classList.remove('active', 'completed');
        step2.classList.remove('active', 'completed');
        step3.classList.remove('active', 'completed');
        line1.classList.remove('completed');
        line2.classList.remove('completed');
        
        // 現在のステップまで更新
        if (step >= 1) {
          step1.classList.add(step > 1 ? 'completed' : 'active');
        }
        
        if (step >= 2) {
          line1.classList.add('completed');
          step2.classList.add(step > 2 ? 'completed' : 'active');
        }
        
        if (step >= 3) {
          line2.classList.add('completed');
          step3.classList.add('active');
        }
      }

      // テンプレート選択に戻るボタンの処理
      backToTemplatesBtn.addEventListener('click', function() {
        updateStep(1);
        mangaEditorScreen.classList.remove('active');
        templateSelectionScreen.classList.add('active');
        
        // 強制的な表示/非表示の設定
        mangaEditorScreen.style.display = 'none';
        templateSelectionScreen.style.display = 'block';
      });

      // 画像をパネルに追加する共通関数
      function addImageToPanel(panel, imageName) {
        // 絶対パスを取得
        const getFullImagePath = (imageName) => {
          // すでに絶対URLなら変更しない
          if (imageName.startsWith('http') || imageName.startsWith('data:')) {
            return imageName;
          }
          
          // キャッシュにあれば使用
          if (imageCache[imageName + '_fullpath']) {
            return imageCache[imageName + '_fullpath'];
          }
          
          // Vercel環境では完全なURLを構築
          if (window.location.hostname.includes('vercel.app')) {
            const baseUrl = window.location.origin;
            return `${baseUrl}/${imageName}`;
          }
          
          // 相対パスを絶対URLに変換
          const a = document.createElement('a');
          a.href = imageName;
          return a.href;
        };
        
        // 絶対パスに変換
        const fullImagePath = getFullImagePath(imageName);
        
        // パネル背景色を変更して視覚的に確認できるようにする
        panel.style.backgroundColor = '#e1f5fe';
        
        // 背景画像として設定する（CSSの方法）
        panel.style.backgroundImage = `url('${fullImagePath}')`;
        panel.style.backgroundSize = 'cover';
        panel.style.backgroundPosition = 'center';
        
        console.log(`パネル ${panel.id} に画像を設定: ${fullImagePath}`);
        
        // インラインでHTMLタグも追加しておく（念のため）
        panel.innerHTML = `
          <img src="${fullImagePath}" 
               alt="${imageName}" 
               crossorigin="anonymous"
               style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:1;">
          <div style="position:absolute; bottom:5px; right:5px; background:#ff0000; color:#fff; padding:2px 5px; font-size:10px; z-index:2;">
            ${imageName}
          </div>
        `;
        
        console.log('画像を追加しました:', imageName);
        
        // すべてのパネルに画像が設定されているか確認
        const panels = document.querySelectorAll('.panel');
        let allPanelsHaveImages = true;
        
        panels.forEach(panel => {
          if (panel.querySelector('img') === null && 
              (!panel.style.backgroundImage || panel.style.backgroundImage === 'none')) {
            allPanelsHaveImages = false;
          }
        });
        
        // すべてのパネルに画像が設定されていれば次のステップに進む
        if (allPanelsHaveImages) {
          updateStep(3);
        }
      }
      
      // 画像適用ボタンの処理
      applyBtn.addEventListener('click', function() {
        const selectedImage = imageSelect.value;
        console.log('画像適用:', selectedImage);
        
        // 既存の画像があれば削除
        const existingImages = currentPanel.querySelectorAll('img');
        existingImages.forEach(img => img.remove());
        
        if (selectedImage) {
          // 画像をパネルに追加
          addImageToPanel(currentPanel, selectedImage);
        } else {
          // 画像なしの場合
          currentPanel.style.backgroundImage = 'none';
          currentPanel.style.backgroundColor = '';
          currentPanel.innerHTML = '';
        }
      });
      
      // リセットボタンの処理
      resetBtn.addEventListener('click', function() {
        const panels = document.querySelectorAll('.panel');
        panels.forEach(panel => {
          // 内容をクリア
          panel.innerHTML = '';
          // 背景画像もクリア
          panel.style.backgroundImage = 'none';
          
          // 台形パネルの場合は薄い色を設定
          if (panel.style.clipPath && panel.style.clipPath !== 'none') {
            panel.style.backgroundColor = '#e8eaf6';
          } else {
            // 通常のパネルには薄い色を設定
            panel.style.backgroundColor = '#f5f5f5';
          }
          
          // 選択状態のボーダーを維持
          if (panel.classList.contains('selected')) {
            panel.style.border = '2px dashed #ff0000';
          } else {
            panel.style.border = '1px solid #000';
          }
        });
        
        imageSelect.value = '';
        updateStep(2); // ステップを2に戻す
      });
      
      // プレビュー画像クリック時の処理
      const previewImages = document.querySelectorAll('.preview-image');
      previewImages.forEach(img => {
        img.addEventListener('click', function() {
          const imageName = this.dataset.image;
          console.log('プレビュー画像クリック:', imageName);
          
          // 画像セレクトボックスの値を更新
          imageSelect.value = imageName;
          
          if (currentPanel) {
            // 画像をパネルに追加
            addImageToPanel(currentPanel, imageName);
          }
        });
      });
      
      // SVG保存ボタンの処理
      exportBtn.addEventListener('click', function() {
        try {
          // 現在のテンプレート情報を取得
          const templateInfo = currentTemplate || {
            title: '漫画',
            panels: []
          };
          
          // 画像をBase64に変換する関数
          const imageToBase64 = async (url) => {
            return new Promise((resolve, reject) => {
              try {
                // 既にデータURLならそのまま返す
                if (url.startsWith('data:')) {
                  resolve(url);
                  return;
                }
                
                // 新しい画像要素を作成して読み込み
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                  try {
                    // 一時的なキャンバスを作成して画像を描画
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // Base64データを取得して返す
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                  } catch (e) {
                    console.error('画像のBase64変換に失敗:', e);
                    // 失敗した場合は元のURLを返す
                    resolve(url);
                  }
                };
                
                img.onerror = () => {
                  console.warn('画像の読み込みに失敗:', url);
                  // 失敗した場合は元のURLを返す
                  resolve(url);
                };
                
                // HTTPリクエストの際にキャッシュを無効化
                img.src = url + (url.includes('?') ? '&' : '?') + 'nocache=' + Date.now();
              } catch (e) {
                console.error('Base64変換エラー:', e);
                resolve(url);
              }
            });
          };
          
          // SVGでコマ割りを完全に再現
          const svgNS = "http://www.w3.org/2000/svg";
          const xlinkNS = "http://www.w3.org/1999/xlink";
          
          // キャンバスサイズ設定
          const CANVAS_SIZE = 1000;
          
          // SVG要素を作成
          const svg = document.createElementNS(svgNS, "svg");
          svg.setAttribute("xmlns", svgNS);
          svg.setAttribute("xmlns:xlink", xlinkNS);
          svg.setAttribute("width", CANVAS_SIZE);
          svg.setAttribute("height", CANVAS_SIZE);
          svg.setAttribute("viewBox", "0 0 100 100");
          svg.style.backgroundColor = "white";
          
          // 背景の白い矩形を追加
          const background = document.createElementNS(svgNS, "rect");
          background.setAttribute("x", "0");
          background.setAttribute("y", "0");
          background.setAttribute("width", "100");
          background.setAttribute("height", "100");
          background.setAttribute("fill", "white");
          svg.appendChild(background);
          
          // ローディングオーバーレイを表示
          const loadingOverlay = document.getElementById('loading-overlay');
          loadingOverlay.style.display = 'flex';
          const loadingText = loadingOverlay.querySelector('.loading-text');
          const processStatus = loadingOverlay.querySelector('.process-status');
          
          loadingText.textContent = 'SVG生成中...';
          processStatus.textContent = '画像をBase64に変換しています...';
          
          // 非同期で画像変換とSVG生成を行う
          (async () => {
            const imgProcessPromises = [];
            const allPanels = document.querySelectorAll('.panel');
            const imageUrlMap = new Map(); // 画像URLとBase64のマッピング
            
            // 先に全ての画像をBase64に変換
            for (const panel of allPanels) {
              const img = panel.querySelector('img');
              if (img && img.src) {
                // 同じURLは処理しない
                if (!imageUrlMap.has(img.src)) {
                  imgProcessPromises.push(
                    imageToBase64(img.src).then(base64 => {
                      imageUrlMap.set(img.src, base64);
                      console.log(`画像変換完了: ${img.src.substring(0, 50)}...`);
                    })
                  );
                }
              }
            }
            
            // 全ての画像変換を待つ
            await Promise.all(imgProcessPromises);
            processStatus.textContent = 'SVGパネル生成中...';
            
            // パネル情報を使ってSVG作成
            if (currentTemplate && currentTemplate.panels) {
              currentTemplate.panels.forEach(panelInfo => {
                const panel = document.getElementById(panelInfo.id);
                if (!panel) return;
                
                // パネル用のグループ要素
                const g = document.createElementNS(svgNS, "g");
                
                // 台形の場合の特殊処理
                if (panelInfo.clipPath) {
                  // 多角形用のポリゴン要素を作成
                  const polygon = document.createElementNS(svgNS, "polygon");
                  
                  // clipPathからポイント情報を抽出
                  const clipPathValue = panelInfo.clipPath.replace("polygon(", "").replace(")", "");
                  const points = [];
                  
                  clipPathValue.split(",").forEach(point => {
                    const trimmedPoint = point.trim();
                    const parts = trimmedPoint.split(" ");
                    const x = parseFloat(parts[0]) * panelInfo.width / 100 + panelInfo.left;
                    const y = parseFloat(parts[1]) * panelInfo.height / 100 + panelInfo.top;
                    points.push(`${x},${y}`);
                  });
                  
                  polygon.setAttribute("points", points.join(" "));
                  polygon.setAttribute("fill", "white");
                  polygon.setAttribute("stroke", "black");
                  polygon.setAttribute("stroke-width", "0.2");
                  g.appendChild(polygon);
                  
                  // クリッピングパス定義
                  const clipPathId = `clip_${panelInfo.id}`;
                  const clipPathElement = document.createElementNS(svgNS, "clipPath");
                  clipPathElement.setAttribute("id", clipPathId);
                  
                  const clipPathPolygon = document.createElementNS(svgNS, "polygon");
                  clipPathPolygon.setAttribute("points", points.join(" "));
                  clipPathElement.appendChild(clipPathPolygon);
                  svg.appendChild(clipPathElement);
                  
                  // 画像要素
                  const img = panel.querySelector('img');
                  if (img) {
                    const svgImage = document.createElementNS(svgNS, "image");
                    // Base64に変換済みの画像URLを使用
                    const imageDataUrl = imageUrlMap.get(img.src) || img.src;
                    svgImage.setAttributeNS(xlinkNS, "href", imageDataUrl);
                    svgImage.setAttribute("x", panelInfo.left);
                    svgImage.setAttribute("y", panelInfo.top);
                    svgImage.setAttribute("width", panelInfo.width);
                    svgImage.setAttribute("height", panelInfo.height);
                    svgImage.setAttribute("preserveAspectRatio", "xMidYMid slice");
                    svgImage.setAttribute("clip-path", `url(#${clipPathId})`);
                    g.appendChild(svgImage);
                  }
                } else {
                  // 通常の矩形パネル
                  const rect = document.createElementNS(svgNS, "rect");
                  rect.setAttribute("x", panelInfo.left);
                  rect.setAttribute("y", panelInfo.top);
                  rect.setAttribute("width", panelInfo.width);
                  rect.setAttribute("height", panelInfo.height);
                  rect.setAttribute("fill", "white");
                  rect.setAttribute("stroke", "black");
                  rect.setAttribute("stroke-width", "0.2");
                  g.appendChild(rect);
                  
                  // 画像クリッピングパス
                  const clipPathId = `clip_${panelInfo.id}`;
                  const clipPathElement = document.createElementNS(svgNS, "clipPath");
                  clipPathElement.setAttribute("id", clipPathId);
                  
                  const clipPathRect = document.createElementNS(svgNS, "rect");
                  clipPathRect.setAttribute("x", panelInfo.left);
                  clipPathRect.setAttribute("y", panelInfo.top);
                  clipPathRect.setAttribute("width", panelInfo.width);
                  clipPathRect.setAttribute("height", panelInfo.height);
                  clipPathElement.appendChild(clipPathRect);
                  svg.appendChild(clipPathElement);
                  
                  // 画像要素
                  const img = panel.querySelector('img');
                  if (img) {
                    const svgImage = document.createElementNS(svgNS, "image");
                    // Base64に変換済みの画像URLを使用
                    const imageDataUrl = imageUrlMap.get(img.src) || img.src;
                    svgImage.setAttributeNS(xlinkNS, "href", imageDataUrl);
                    svgImage.setAttribute("x", panelInfo.left);
                    svgImage.setAttribute("y", panelInfo.top);
                    svgImage.setAttribute("width", panelInfo.width);
                    svgImage.setAttribute("height", panelInfo.height);
                    svgImage.setAttribute("preserveAspectRatio", "xMidYMid slice");
                    svgImage.setAttribute("clip-path", `url(#${clipPathId})`);
                    g.appendChild(svgImage);
                  }
                }
                
                // パネル番号
                const text = document.createElementNS(svgNS, "text");
                text.setAttribute("x", panelInfo.left + 1);
                text.setAttribute("y", panelInfo.top + 4);
                text.setAttribute("fill", "red");
                text.setAttribute("font-size", "2.5");
                text.textContent = panelInfo.id.replace("panel", "");
                g.appendChild(text);
                
                svg.appendChild(g);
              });
            }
            
            processStatus.textContent = 'SVG生成完了';
            
            // SVGを文字列に変換
            const svgData = new XMLSerializer().serializeToString(svg);
            
            // SVGプレビューを左上に表示
            const imgTest = document.createElement('div');
            imgTest.setAttribute('style', 'position:fixed; top:10px; left:10px; width:auto; padding:10px; z-index:9999; border:2px solid red; background:white; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2);');
            
            // エンコード方法を変更（XMLエンティティも適切に処理）
            const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
            const svgUrl = URL.createObjectURL(svgBlob);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `${templateInfo.title}-${timestamp}.svg`;
            
            imgTest.innerHTML = `
              <p style="margin:0 0 10px 0; font-size:14px;">SVGプレビュー (正しいSVG)</p>
              <img src="${svgUrl}" style="width:500px; height:500px; display:block; margin-bottom:10px; border:1px solid #ccc;" />
              <div style="display:flex; justify-content:space-between;">
                <button id="download-svg-preview" style="padding:8px 15px; background:#4CAF50; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">このSVGをダウンロード</button>
                <button id="close-svg-preview" style="padding:8px 15px; background:#f44336; color:white; border:none; border-radius:3px; cursor:pointer;">閉じる</button>
              </div>
            `;
            
            document.body.appendChild(imgTest);
            
            // ローディングオーバーレイを非表示
            loadingOverlay.style.display = 'none';
            
            // ダウンロードボタンのクリックイベント
            document.getElementById('download-svg-preview').addEventListener('click', function() {
              try {
                // Blobを使用してダウンロード
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.download = filename;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // URLを解放
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                console.log('SVGファイルが保存されました');
              } catch (error) {
                console.error('SVGダウンロード中にエラーが発生:', error);
                alert('SVGのダウンロードに失敗しました: ' + error.message);
              }
            });
            
            // 閉じるボタンのクリックイベント
            document.getElementById('close-svg-preview').addEventListener('click', function() {
              document.body.removeChild(imgTest);
              // オブジェクトURLの解放
              URL.revokeObjectURL(svgUrl);
            });
          })();
          
        } catch (error) {
          console.error('SVG生成中にエラーが発生しました:', error);
          alert('SVG生成中にエラーが発生しました: ' + error.message);
          
          // エラー時もローディングを非表示
          const loadingOverlay = document.getElementById('loading-overlay');
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
        }
      });
      
      // 追加のSVG出力ボタンを無効化
      if (document.getElementById('export-svg-btn')) {
        document.getElementById('export-svg-btn').style.display = 'none';
      }
    });
  </script>
</body>
</html>