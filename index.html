<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manga Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    :root {
      /* Light mode (default) */
      --background-color: #ffffff;
      --text-color: #000000;
      --card-background: #ffffff;
      --card-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      --panel-border: 1px solid #000000;
      --panel-background: #f5f5f5;
      --header-background: #ffffff;
      --control-background: #ffffff;
      --primary-button: #4CAF50;
      --primary-button-hover: #45a049;
      --secondary-button: #2196F3;
      --secondary-button-hover: #0b7dda;
      --danger-button: #f44336;
      --danger-button-hover: #d32f2f;
      --spinner-color: #3498db;
      --loading-overlay: rgba(0, 0, 0, 0.7);
      --step-inactive: #ddd;
      --step-active: #4CAF50;
    }

    [data-theme="dark"] {
      --background-color: #121212;
      --text-color: #ffffff;
      --card-background: #1e1e1e;
      --card-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      --panel-border: 1px solid #ffffff;
      --panel-background: #2d2d2d;
      --header-background: #1e1e1e;
      --control-background: #1e1e1e;
      --primary-button: #4CAF50;
      --primary-button-hover: #45a049;
      --secondary-button: #2196F3;
      --secondary-button-hover: #0b7dda;
      --danger-button: #f44336;
      --danger-button-hover: #d32f2f;
      --spinner-color: #3498db;
      --loading-overlay: rgba(0, 0, 0, 0.8);
      --step-inactive: #444;
      --step-active: #4CAF50;
    }
    
    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background-color: var(--header-background);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .navbar .logo {
      font-size: 24px;
      font-weight: bold;
      text-decoration: none;
      color: var(--text-color);
    }
    
    .navbar .nav-links {
      display: flex;
      gap: 20px;
    }
    
    .navbar .nav-links a {
      text-decoration: none;
      color: var(--text-color);
      padding: 5px 10px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    
    .navbar .nav-links a:hover {
      background-color: rgba(128, 128, 128, 0.1);
    }

    .theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-color);
      font-size: 20px;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      color: var(--text-color);
      margin-top: 30px;
      margin-bottom: 20px;
      font-size: 32px;
    }
    
    .welcome-message {
      text-align: center;
      margin-bottom: 30px;
      color: var(--text-color);
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .template-card {
      background-color: var(--card-background);
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    
    .template-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .template-thumbnail {
      width: 100%;
      height: 200px;
      background-color: var(--panel-background);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    
    .template-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .template-thumbnail img:hover {
      transform: scale(1.05);
    }
    
    .template-info {
      padding: 15px;
    }
    
    .template-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
      color: var(--text-color);
    }
    
    .template-description {
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.8;
    }

    .thumbnail-placeholder {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 2px;
    }

    .thumbnail-panel {
      border: var(--panel-border);
      background-color: var(--panel-background);
      box-sizing: border-box;
      min-height: 10px;
      min-width: 10px;
    }
    
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      background: var(--control-background);
      padding: 15px;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
    }
    
    .panel-selector {
      display: flex;
      align-items: center;
    }
    
    .panel-selector label {
      margin-right: 10px;
      font-weight: bold;
    }
    
    .image-selector {
      display: flex;
      align-items: center;
    }
    
    .image-selector label {
      margin-right: 10px;
      font-weight: bold;
    }
    
    select {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--text-color);
      background-color: var(--background-color);
      color: var(--text-color);
      font-size: 16px;
    }
    
    button {
      padding: 8px 15px;
      background-color: var(--primary-button);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-left: 10px;
      transition: background-color 0.3s ease;
    }
    
    button:hover {
      background-color: var(--primary-button-hover);
    }
    
    .export-btn {
      background-color: var(--secondary-button);
    }
    
    .export-btn:hover {
      background-color: var(--secondary-button-hover);
    }

    .back-btn {
      background-color: var(--danger-button);
      margin-right: auto;
    }
    
    .back-btn:hover {
      background-color: var(--danger-button-hover);
    }
    
    #loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--loading-overlay);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--spinner-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
      margin-bottom: 20px;
    }
    
    .loading-text {
      color: white;
      font-size: 18px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .manga-container {
      width: 100%;
      max-width: 800px;
      height: auto;
      aspect-ratio: 1;
      background-color: white;
      border: 1px solid #333;
      position: relative;
      margin: 0 auto 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
      overflow: hidden;
    }
    
    .panel {
      position: absolute;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border: 1px solid #000;
      box-sizing: border-box;
      overflow: hidden;
      background-color: #f5f5f5;
    }
    
    .panel.selected {
      border: 2px dashed #ff0000;
    }

    /* å°å½¢ãªã©ã®ç‰¹æ®Šå½¢çŠ¶ã®ã‚³ãƒã®å¢ƒç•Œç·šç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 1px solid #000;
      pointer-events: none;
      clip-path: inherit;
      z-index: 2;
    }
    
    .panel.selected::before {
      border: 2px dashed #ff0000;
    }

    /* å„ã‚³ãƒã®è‰²åˆ†ã‘ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .panel[id="panel1"] {
      background-color: #e3f2fd; /* è–„ã„é’ */
    }
    
    .panel[id="panel2"] {
      background-color: #e8f5e9; /* è–„ã„ç·‘ */
    }
    
    .panel[id="panel3"] {
      background-color: #fff3e0; /* è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
    }
    
    .panel[id="panel4"] {
      background-color: #f3e5f5; /* è–„ã„ç´« */
    }
    
    /* å„ãƒ‘ãƒãƒ«ã®ä½ç½®ã¨ã‚µã‚¤ã‚º */
    #panel1 {
      top: 0;
      left: 0;
      width: 40%;
      height: 70%;
    }
    
    #panel2 {
      top: 0;
      left: 40%;
      width: 60%;
      height: 35%;
    }
    
    #panel3 {
      top: 35%;
      left: 40%;
      width: 60%;
      height: 35%;
    }
    
    #panel4 {
      top: 70%;
      left: 0;
      width: 100%;
      height: 30%;
    }
    
    .image-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .preview-item {
      text-align: center;
    }
    
    .preview-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 1px solid #ddd;
      margin-bottom: 5px;
      cursor: pointer;
    }
    
    .preview-image:hover {
      border-color: #4CAF50;
    }

    #template-selection-screen.active {
      display: block;
    }

    #template-selection-screen:not(.active) {
      display: none;
    }

    #manga-editor-screen.active {
      display: block;
    }

    #manga-editor-screen:not(.active) {
      display: none;
    }

    .progress-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 200px;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--step-inactive);
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 5px;
      position: relative;
      z-index: 2;
    }

    .step-circle.active {
      background-color: var(--step-active);
      color: white;
    }

    .step-circle.completed {
      background-color: var(--step-active);
      color: white;
    }

    .step-line {
      width: 100px;
      height: 3px;
      background-color: var(--step-inactive);
      position: relative;
      top: -18px;
      z-index: 1;
    }

    .step-line.completed {
      background-color: var(--step-active);
    }

    .step-text {
      font-size: 14px;
      color: var(--text-color);
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* å…¨ç”»é¢ã®ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .button-area {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
    .template-preview-template1 {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
    }

    .template-preview-template2 {
      grid-template-columns: 1fr;
      grid-template-rows: 1fr 1fr 1fr 1fr;
    }

    .template-preview-template3 .thumbnail-panel:first-child {
      grid-row: span 3;
      grid-column: 1;
    }
    .template-preview-template3 .thumbnail-panel:nth-child(2),
    .template-preview-template3 .thumbnail-panel:nth-child(3),
    .template-preview-template3 .thumbnail-panel:nth-child(4) {
      grid-column: 2;
    }

    .template-preview-template4 .thumbnail-panel:first-child {
      grid-row: span 2;
      grid-column: 1;
    }
    .template-preview-template4 .thumbnail-panel:nth-child(2),
    .template-preview-template4 .thumbnail-panel:nth-child(3) {
      grid-column: 2;
    }
    .template-preview-template4 .thumbnail-panel:nth-child(4) {
      grid-column: span 2;
    }

    .template-preview-template5 {
      grid-template-columns: 1fr 1fr 1fr 1fr;
      grid-template-rows: 1fr;
    }

    .template-preview-template6 .thumbnail-panel:nth-child(odd) {
      margin-right: 25%;
    }
    .template-preview-template6 .thumbnail-panel:nth-child(even) {
      margin-left: 25%;
    }

    .template-preview-template7 .thumbnail-panel:first-child {
      grid-column: span 3;
    }
    .template-preview-template7 .thumbnail-panel:nth-child(2),
    .template-preview-template7 .thumbnail-panel:nth-child(3),
    .template-preview-template7 .thumbnail-panel:nth-child(4) {
      grid-row: 2;
    }

    .template-preview-template8 .thumbnail-panel:first-child,
    .template-preview-template8 .thumbnail-panel:nth-child(2) {
      grid-row: 1;
    }
    .template-preview-template8 .thumbnail-panel:nth-child(3),
    .template-preview-template8 .thumbnail-panel:nth-child(4) {
      grid-row: 2;
    }

    .template-preview-template9 .thumbnail-panel:nth-child(2) {
      grid-row: span 2;
      grid-column: 2;
    }
    .template-preview-template9 .thumbnail-panel:nth-child(4) {
      grid-column: span 2;
    }

    .template-preview-template10 .thumbnail-panel:first-child {
      grid-column: 2;
      grid-row: 1;
    }
    .template-preview-template10 .thumbnail-panel:nth-child(2) {
      grid-column: 1;
      grid-row: 2;
    }
    .template-preview-template10 .thumbnail-panel:nth-child(3) {
      grid-column: 2;
      grid-row: 2;
    }
    .template-preview-template10 .thumbnail-panel:nth-child(4) {
      grid-column: 3;
      grid-row: 2;
    }

    /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .template-header {
      background-color: var(--header-background);
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
    }

    .template-header h2 {
      margin: 0 0 5px 0;
      color: var(--text-color);
      font-size: 20px;
    }

    .template-header p {
      margin: 0;
      color: var(--text-color);
      font-size: 14px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="#" class="logo">Manga Generator</a>
    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle theme">
      <span id="theme-icon">ğŸŒ™</span>
    </button>
  </nav>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text">Generating image...</div>
    <div class="process-status" style="color:white; margin-top:10px; font-size:14px;"></div>
  </div>
  
  <div class="container">
    <h1>Manga Generator</h1>
    
    <!-- Progress Indicator -->
    <div class="progress-bar">
      <div class="progress-step">
        <div class="step-circle active" id="step1">1</div>
        <div class="step-text">Select Template</div>
      </div>
      <div class="step-line" id="line1"></div>
      <div class="progress-step">
        <div class="step-circle" id="step2">2</div>
        <div class="step-text">Place Images</div>
      </div>
      <div class="step-line" id="line2"></div>
      <div class="progress-step">
        <div class="step-circle" id="step3">3</div>
        <div class="step-text">Complete & Export</div>
      </div>
    </div>
    
    <!-- Template Selection Screen -->
    <div id="template-selection-screen" class="screen active">
      <div class="welcome-message">
        <p>Please select a manga panel layout template below.</p>
      </div>
      
      <div class="template-grid" id="template-grid">
        <!-- Templates will be dynamically inserted by JavaScript -->
      </div>
    </div>
    
    <!-- Manga Editor Screen -->
    <div id="manga-editor-screen" class="screen">
    <div class="controls">
        <button id="back-to-templates-btn" class="back-btn">Back</button>
        
      <div class="panel-selector">
        <label for="panel-select">Select Panel:</label>
        <select id="panel-select">
            <option value="panel1">Panel 1</option>
            <option value="panel2">Panel 2</option>
            <option value="panel3">Panel 3</option>
            <option value="panel4">Panel 4</option>
        </select>
      </div>
      
      <div class="image-selector">
        <label for="image-select">Select Image:</label>
        <select id="image-select">
          <option value="">No image</option>
          <option value="1.png">1.png</option>
          <option value="2.png">2.png</option>
          <option value="3.png">3.png</option>
          <option value="4.png">4.png</option>
          <option value="5.png">5.png</option>
        </select>
        <button id="apply-btn">Apply</button>
        <button id="reset-btn">Reset</button>
        <button id="export-btn" class="export-btn">Save SVG</button>
        <button id="export-svg-btn" style="background-color: #FF9800; display: none;">Save SVG</button>
      </div>
    </div>
    
      <!-- Template Information -->
      <div class="template-header" id="template-header">
        <h2>Template Name</h2>
        <p>Template description</p>
      </div>
      
      <div class="manga-container" id="manga-container">
        <!-- Panels will be dynamically inserted by JavaScript -->
      </div>
    
    <div class="image-preview">
      <div class="preview-item">
          <img src="1.png" alt="1.png" class="preview-image" data-image="1.png" crossorigin="anonymous">
        <div>1.png</div>
      </div>
      <div class="preview-item">
          <img src="2.png" alt="2.png" class="preview-image" data-image="2.png" crossorigin="anonymous">
        <div>2.png</div>
      </div>
      <div class="preview-item">
          <img src="3.png" alt="3.png" class="preview-image" data-image="3.png" crossorigin="anonymous">
        <div>3.png</div>
      </div>
      <div class="preview-item">
          <img src="4.png" alt="4.png" class="preview-image" data-image="4.png" crossorigin="anonymous">
        <div>4.png</div>
      </div>
      <div class="preview-item">
          <img src="5.png" alt="5.png" class="preview-image" data-image="5.png" crossorigin="anonymous">
        <div>5.png</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = document.getElementById('theme-icon');
      
      // Check for saved user preference
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeIcon.textContent = 'â˜€ï¸';
      }
      
      // Toggle theme
      themeToggle.addEventListener('click', function() {
        if (document.documentElement.getAttribute('data-theme') === 'dark') {
          document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
          themeIcon.textContent = 'ğŸŒ™';
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          themeIcon.textContent = 'â˜€ï¸';
        }
      });
    });
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å¿…è¦ãªAPIã‚’å®šç¾©ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç”¨ï¼‰
    window.createObjectURL = (window.URL || window.webkitURL || {}).createObjectURL || function(){};
    window.Blob = window.Blob || function(){};

    document.addEventListener('DOMContentLoaded', function() {
      // çŠ¶æ…‹ç®¡ç†
      let currentStep = 1;
      let currentTemplate = null;
      let currentPanel = null;
      
      // ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
      const preloadImages = ['1.png', '2.png', '3.png', '4.png', '5.png'];
      const imageCache = {};
      
      // ç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
      preloadImages.forEach(src => {
        const img = new Image();
        img.crossOrigin = "anonymous"; // CORSå¯¾å¿œã‚’è¿½åŠ 
        
        // ãƒ•ãƒ«ãƒ‘ã‚¹ã«å¤‰æ›ã—ã¦ä¿å­˜ã—ã¦ãŠãé–¢æ•°
        const saveFullPath = () => {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ç”»åƒã‚’ä¿å­˜
          imageCache[src] = img;
          
          // çµ¶å¯¾URLã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
          if (img.src.startsWith('http') || img.src.startsWith('data:')) {
            imageCache[src + '_fullpath'] = img.src;
            console.log(`Image absolute path cached: ${src} -> ${img.src}`);
          }
        };
        
        img.onload = () => {
          console.log(`Image preload completed: ${src}`);
          saveFullPath();
        };
        
        img.onerror = () => {
          console.warn('Failed to load image:', src);
          // å¤±æ•—ã—ãŸå ´åˆã¯å…ƒã®URLã‚’è¿”ã™
          if (!src.startsWith('./')) {
            img.src = './' + src;
          } else {
            console.error(`Final image load failure: ${src}`);
          }
        };
        
        // çµ¶å¯¾URLã®å ´åˆã¯ç›´æ¥ã€ãã†ã§ãªã‘ã‚Œã°Varcelã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã‚’è©¦ã™
        if (window.location.hostname.includes('vercel.app')) {
          // Vercelç’°å¢ƒã§ã¯å®Œå…¨ãªURLã‚’æ§‹ç¯‰
          const baseUrl = window.location.origin;
          img.src = `${baseUrl}/${src}`;
          console.log(`Vercel environment image path: ${img.src}`);
        } else {
          // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒãªã©
          img.src = src;
        }
      });
      
      // è¦ç´ ã®å–å¾—
      const templateSelectionScreen = document.getElementById('template-selection-screen');
      const mangaEditorScreen = document.getElementById('manga-editor-screen');
      const templateGrid = document.getElementById('template-grid');
      const mangaContainer = document.getElementById('manga-container');
      const panelSelect = document.getElementById('panel-select');
      const imageSelect = document.getElementById('image-select');
      const applyBtn = document.getElementById('apply-btn');
      const resetBtn = document.getElementById('reset-btn');
      const exportBtn = document.getElementById('export-btn');
      const exportSvgBtn = document.getElementById('export-svg-btn');
      const backToTemplatesBtn = document.getElementById('back-to-templates-btn');
      const loadingOverlay = document.getElementById('loading-overlay');
      
      // é€²è¡ŒçŠ¶æ³è¦ç´ 
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      const line1 = document.getElementById('line1');
      const line2 = document.getElementById('line2');

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾©ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      let templateDefinitions = {};

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€
      async function loadTemplatesData() {
        try {
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
          const response = await fetch('templates/templates.json');
          if (!response.ok) {
            throw new Error('Failed to load template list');
          }
          const templatesData = await response.json();
          console.log('Templates loaded:', templatesData);
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
          displayTemplateCards(templatesData);
          
          // å„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è©³ç´°ã‚’èª­ã¿è¾¼ã‚€
          await loadTemplateDefinitions(templatesData.templates);
          
          console.log('All template definitions loaded successfully');
        } catch (error) {
          console.error('Error loading templates:', error);
          alert('Failed to load templates. Using default template.');
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
          const defaultTemplatesData = {
            "templates": [
              {
                "id": "template1",
                "title": "Standard 4-Panel",
                "description": "Standard layout with 2 rows of 2 panels",
                "thumbnail": "thumbnails/template1.png"
              }
            ]
          };
          displayTemplateCards(defaultTemplatesData);
        }
      }
      
      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾©ã‚’èª­ã¿è¾¼ã‚€
      async function loadTemplateDefinitions(templates) {
        const promises = templates.map(async (template) => {
          try {
            const response = await fetch(`templates/${template.id}.json`);
            if (!response.ok) {
              throw new Error(`Failed to load template ${template.id}`);
            }
            const templateData = await response.json();
            templateDefinitions[template.id] = templateData;
            console.log(`Template ${template.id} loaded:`, templateData);
          } catch (error) {
            console.error(`Error loading template ${template.id}:`, error);
          }
        });
        
        // ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚’å¾…æ©Ÿ
        await Promise.all(promises);
      }
      
      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
      function displayTemplateCards(templatesData) {
        templateGrid.innerHTML = ''; // ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢
        console.log('Displaying template list');
        
        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã®ä½œæˆ
        templatesData.templates.forEach(template => {
          const templateCard = document.createElement('div');
          templateCard.className = 'template-card';
          templateCard.dataset.templateId = template.id;
          
          // ã‚µãƒ ãƒã‚¤ãƒ«ãŒãªã„å ´åˆã®ä»£æ›¿è¡¨ç¤º
          const thumbnailHTML = `
            <div class="template-thumbnail">
              <img src="${template.id <= 5 ? template.id + '.png' : 'thumbnails/' + template.id.replace('template', '') + '.png'}" 
                   alt="${template.title}" 
                   style="max-width: 100%; max-height: 100%; object-fit: cover;">
            </div>
          `;
          
          templateCard.innerHTML = `
            ${thumbnailHTML}
            <div class="template-info">
              <div class="template-title">${template.title}</div>
              <div class="template-description">${template.description}</div>
            </div>
          `;
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
          templateCard.addEventListener('click', () => {
            console.log('Template card clicked:', template.id);
            try {
              loadTemplateFromDefinition(template.id);
            } catch (error) {
              console.error('Error loading template:', error);
              alert('Failed to load template. Using default template.');
              useDefaultTemplate();
            }
          });
          
          templateGrid.appendChild(templateCard);
        });
      }

      // åˆæœŸåŒ–å‡¦ç†ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€
      loadTemplatesData();

      // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰èª­ã¿è¾¼ã‚€å‡¦ç†
      function loadTemplateFromDefinition(templateId) {
        console.log('Loading template:', templateId);
        
        if (templateDefinitions[templateId]) {
          const template = templateDefinitions[templateId];
          console.log('Template loaded:', template);
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜
          currentTemplate = template;
          
          // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
          updateStep(2);
          
          // æ¼«ç”»ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
          mangaContainer.innerHTML = '';
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤º
          const templateHeader = document.getElementById('template-header');
          templateHeader.innerHTML = `
            <h2>${template.title}</h2>
            <p>${template.description}</p>
          `;
          
          // ãƒ‘ãƒãƒ«ã®ä½œæˆ
          template.panels.forEach(panel => {
            const panelElement = document.createElement('div');
            panelElement.id = panel.id;
            panelElement.className = 'panel';
            panelElement.style.top = `${panel.top}%`;
            panelElement.style.left = `${panel.left}%`;
            panelElement.style.width = `${panel.width}%`;
            panelElement.style.height = `${panel.height}%`;
            panelElement.style.backgroundSize = 'cover';
            panelElement.style.backgroundPosition = 'center';
            
            // clipPathãŒã‚ã‚‹å ´åˆã¯é©ç”¨
            if (panel.clipPath) {
              panelElement.style.clipPath = panel.clipPath;
              // èƒŒæ™¯è‰²ã¯å„ãƒ‘ãƒãƒ«IDã«åŸºã¥ã„ã¦è‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã¾ã™ï¼ˆCSSå´ï¼‰
            }
            
            // ä½ç½®æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ä¿å­˜
            panelElement.dataset.top = `${panel.top}%`;
            panelElement.dataset.left = `${panel.left}%`;
            panelElement.dataset.width = `${panel.width}%`;
            panelElement.dataset.height = `${panel.height}%`;
            
            // ãƒ‘ãƒãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
            panelElement.addEventListener('click', function() {
              selectPanel(this);
            });
            
            mangaContainer.appendChild(panelElement);
          });
          
          // æœ€åˆã®ãƒ‘ãƒãƒ«ã‚’é¸æŠ
          currentPanel = document.getElementById('panel1');
          currentPanel.classList.add('selected');
          
          // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
          templateSelectionScreen.classList.remove('active');
          mangaEditorScreen.classList.add('active');
          
          // å¼·åˆ¶çš„ãªè¡¨ç¤º/éè¡¨ç¤ºã®è¨­å®š
          templateSelectionScreen.style.display = 'none';
          mangaEditorScreen.style.display = 'block';
        } else {
          console.error(`Template ${templateId} not found`);
          alert(`Template ${templateId} not found. Using default template.`);
          useDefaultTemplate();
        }
      }

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹é–¢æ•°
      async function useDefaultTemplate() {
        try {
          // æ¨™æº–çš„ãª4ã‚³ãƒæ¼«ç”»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€
          const response = await fetch('templates/template1.json');
          if (!response.ok) {
            throw new Error('Failed to load default template');
          }
          
          const defaultTemplateData = await response.json();
          console.log('Default template loaded:', defaultTemplateData);
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜
          currentTemplate = defaultTemplateData;
          
          // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°
          updateStep(2);
          
          // æ¼«ç”»ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
          mangaContainer.innerHTML = '';
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤º
          const templateHeader = document.getElementById('template-header');
          templateHeader.innerHTML = `
            <h2>${defaultTemplateData.title}</h2>
            <p>${defaultTemplateData.description}</p>
          `;
          
          // ãƒ‘ãƒãƒ«ã®ä½œæˆ
          defaultTemplateData.panels.forEach(panel => {
            const panelElement = document.createElement('div');
            panelElement.id = panel.id;
            panelElement.className = 'panel';
            panelElement.style.top = `${panel.top}%`;
            panelElement.style.left = `${panel.left}%`;
            panelElement.style.width = `${panel.width}%`;
            panelElement.style.height = `${panel.height}%`;
            panelElement.style.backgroundSize = 'cover';
            panelElement.style.backgroundPosition = 'center';
            
            // clipPathãŒã‚ã‚‹å ´åˆã¯é©ç”¨
            if (panel.clipPath) {
              panelElement.style.clipPath = panel.clipPath;
              // èƒŒæ™¯è‰²ã¯å„ãƒ‘ãƒãƒ«IDã«åŸºã¥ã„ã¦è‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã¾ã™ï¼ˆCSSå´ï¼‰
            }
            
            // ä½ç½®æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨ã—ã¦ä¿å­˜
            panelElement.dataset.top = `${panel.top}%`;
            panelElement.dataset.left = `${panel.left}%`;
            panelElement.dataset.width = `${panel.width}%`;
            panelElement.dataset.height = `${panel.height}%`;
            
            // ãƒ‘ãƒãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
            panelElement.addEventListener('click', function() {
              selectPanel(this);
            });
            
            mangaContainer.appendChild(panelElement);
          });
          
          // æœ€åˆã®ãƒ‘ãƒãƒ«ã‚’é¸æŠ
          currentPanel = document.getElementById('panel1');
          currentPanel.classList.add('selected');
          
          // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
          templateSelectionScreen.classList.remove('active');
          mangaEditorScreen.classList.add('active');
          
          // å¼·åˆ¶çš„ãªè¡¨ç¤º/éè¡¨ç¤ºã®è¨­å®š
          templateSelectionScreen.style.display = 'none';
          mangaEditorScreen.style.display = 'block';
        } catch (error) {
          console.error('Error loading default template:', error);
          
          // ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
          const fallbackTemplateData = {
            title: "Standard 4-Panel (Fallback)",
            description: "Standard layout with 2 rows of 2 panels",
            panels: [
              { id: "panel1", top: 0, left: 0, width: 50, height: 50 },
              { id: "panel2", top: 0, left: 50, width: 50, height: 50 },
              { id: "panel3", top: 50, left: 0, width: 50, height: 50 },
              { id: "panel4", top: 50, left: 50, width: 50, height: 50 }
            ]
          };
          
          currentTemplate = fallbackTemplateData;
          updateStep(2);
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¡¨ç¤º
          const templateHeader = document.getElementById('template-header');
          templateHeader.innerHTML = `
            <h2>${fallbackTemplateData.title}</h2>
            <p>${fallbackTemplateData.description}</p>
          `;
          
          // æ®‹ã‚Šã®ã‚³ãƒ¼ãƒ‰ã¯åŒã˜...
          mangaContainer.innerHTML = '';
          
          fallbackTemplateData.panels.forEach(panel => {
            const panelElement = document.createElement('div');
            panelElement.id = panel.id;
            panelElement.className = 'panel';
            panelElement.style.top = `${panel.top}%`;
            panelElement.style.left = `${panel.left}%`;
            panelElement.style.width = `${panel.width}%`;
            panelElement.style.height = `${panel.height}%`;
            panelElement.style.backgroundSize = 'cover';
            panelElement.style.backgroundPosition = 'center';
            
            // clipPathãŒã‚ã‚‹å ´åˆã¯é©ç”¨
            if (panel.clipPath) {
              panelElement.style.clipPath = panel.clipPath;
              // èƒŒæ™¯è‰²ã¯å„ãƒ‘ãƒãƒ«IDã«åŸºã¥ã„ã¦è‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã¾ã™ï¼ˆCSSå´ï¼‰
            }
            
            panelElement.dataset.top = `${panel.top}%`;
            panelElement.dataset.left = `${panel.left}%`;
            panelElement.dataset.width = `${panel.width}%`;
            panelElement.dataset.height = `${panel.height}%`;
            
            panelElement.addEventListener('click', function() {
              selectPanel(this);
            });
            
            mangaContainer.appendChild(panelElement);
          });
          
          currentPanel = document.getElementById('panel1');
          currentPanel.classList.add('selected');
          
          templateSelectionScreen.classList.remove('active');
          mangaEditorScreen.classList.add('active');
          
          templateSelectionScreen.style.display = 'none';
          mangaEditorScreen.style.display = 'block';
        }
      }

      // ãƒ‘ãƒãƒ«é¸æŠå‡¦ç†
      function selectPanel(panel) {
        if (currentPanel) {
          currentPanel.classList.remove('selected');
          // é€šå¸¸ã®æ ç·šã«æˆ»ã™
          currentPanel.style.border = '1px solid #000';
        }
        
        currentPanel = panel;
        currentPanel.classList.add('selected');
        // èµ¤ã„ç‚¹ç·šã®æ ç·šã«å¤‰æ›´
        currentPanel.style.border = '2px dashed #ff0000';
        
        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å€¤ã‚’æ›´æ–°
        panelSelect.value = currentPanel.id;
        
        // ç”»åƒãŒã‚ã‚Œã°ãã‚Œã‚’ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã§é¸æŠ
        if (currentPanel.style.backgroundImage && currentPanel.style.backgroundImage !== 'none') {
          // èƒŒæ™¯ç”»åƒã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŠ½å‡º
          const bgImageUrl = currentPanel.style.backgroundImage;
          const match = bgImageUrl.match(/url\(['"]?([^'"]+)['"]?\)/i);
          if (match && match[1]) {
            const imagePath = match[1];
            const imageName = imagePath.substring(imagePath.lastIndexOf('/') + 1);
            imageSelect.value = imageName;
          } else {
            imageSelect.value = '';
          }
        } else {
          imageSelect.value = '';
        }
      }
      
      // ãƒ‘ãƒãƒ«é¸æŠæ™‚ã®å‡¦ç†
      panelSelect.addEventListener('change', function() {
        // ç¾åœ¨ã®é¸æŠã‚’è§£é™¤
        if (currentPanel) {
        currentPanel.classList.remove('selected');
          // é€šå¸¸ã®æ ç·šã«æˆ»ã™
          currentPanel.style.border = '1px solid #000';
        }
        
        // æ–°ã—ã„ãƒ‘ãƒãƒ«ã‚’é¸æŠ
        const panelId = this.value;
        currentPanel = document.getElementById(panelId);
        currentPanel.classList.add('selected');
        // èµ¤ã„ç‚¹ç·šã®æ ç·šã«å¤‰æ›´
        currentPanel.style.border = '2px dashed #ff0000';
        
        // ç”»åƒãŒã‚ã‚Œã°ãã‚Œã‚’ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã§é¸æŠ
        if (currentPanel.style.backgroundImage && currentPanel.style.backgroundImage !== 'none') {
          // èƒŒæ™¯ç”»åƒã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŠ½å‡º
          const bgImageUrl = currentPanel.style.backgroundImage;
          const match = bgImageUrl.match(/url\(['"]?([^'"]+)['"]?\)/i);
          if (match && match[1]) {
            const imagePath = match[1];
            const imageName = imagePath.substring(imagePath.lastIndexOf('/') + 1);
          imageSelect.value = imageName;
          } else {
            imageSelect.value = '';
          }
        } else {
          imageSelect.value = '';
        }
      });

      // ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°å‡¦ç†
      function updateStep(step) {
        currentStep = step;
        
        // ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
        step1.classList.remove('active', 'completed');
        step2.classList.remove('active', 'completed');
        step3.classList.remove('active', 'completed');
        line1.classList.remove('completed');
        line2.classList.remove('completed');
        
        // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã¾ã§æ›´æ–°
        if (step >= 1) {
          step1.classList.add(step > 1 ? 'completed' : 'active');
        }
        
        if (step >= 2) {
          line1.classList.add('completed');
          step2.classList.add(step > 2 ? 'completed' : 'active');
        }
        
        if (step >= 3) {
          line2.classList.add('completed');
          step3.classList.add('active');
        }
      }

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
      backToTemplatesBtn.addEventListener('click', function() {
        updateStep(1);
        mangaEditorScreen.classList.remove('active');
        templateSelectionScreen.classList.add('active');
        
        // å¼·åˆ¶çš„ãªè¡¨ç¤º/éè¡¨ç¤ºã®è¨­å®š
        mangaEditorScreen.style.display = 'none';
        templateSelectionScreen.style.display = 'block';
      });

      // ç”»åƒã‚’ãƒ‘ãƒãƒ«ã«è¿½åŠ ã™ã‚‹å…±é€šé–¢æ•°
      function addImageToPanel(panel, imageName) {
        // çµ¶å¯¾ãƒ‘ã‚¹ã‚’å–å¾—
        const getFullImagePath = (imageName) => {
          // ã™ã§ã«çµ¶å¯¾URLãªã‚‰å¤‰æ›´ã—ãªã„
          if (imageName.startsWith('http') || imageName.startsWith('data:')) {
            return imageName;
          }
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ã‚Œã°ä½¿ç”¨
          if (imageCache[imageName + '_fullpath']) {
            return imageCache[imageName + '_fullpath'];
          }
          
          // Vercelç’°å¢ƒã§ã¯å®Œå…¨ãªURLã‚’æ§‹ç¯‰
          if (window.location.hostname.includes('vercel.app')) {
            const baseUrl = window.location.origin;
            return `${baseUrl}/${imageName}`;
          }
          
          // ç›¸å¯¾ãƒ‘ã‚¹ã‚’çµ¶å¯¾URLã«å¤‰æ›
          const a = document.createElement('a');
          a.href = imageName;
          return a.href;
        };
        
        // çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
        const fullImagePath = getFullImagePath(imageName);
        
        // ãƒ‘ãƒãƒ«èƒŒæ™¯è‰²ã‚’å¤‰æ›´ã—ã¦è¦–è¦šçš„ã«ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        panel.style.backgroundColor = '#e1f5fe';
        
        // èƒŒæ™¯ç”»åƒã¨ã—ã¦è¨­å®šã™ã‚‹ï¼ˆCSSã®æ–¹æ³•ï¼‰
        panel.style.backgroundImage = `url('${fullImagePath}')`;
        panel.style.backgroundSize = 'cover';
        panel.style.backgroundPosition = 'center';
        
        console.log(`ãƒ‘ãƒãƒ« ${panel.id} ã«ç”»åƒã‚’è¨­å®š: ${fullImagePath}`);
        
        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§HTMLã‚¿ã‚°ã‚‚è¿½åŠ ã—ã¦ãŠãï¼ˆå¿µã®ãŸã‚ï¼‰
        panel.innerHTML = `
          <img src="${fullImagePath}" 
               alt="${imageName}" 
               crossorigin="anonymous"
               style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; z-index:1;">
          <div style="position:absolute; bottom:5px; right:5px; background:#ff0000; color:#fff; padding:2px 5px; font-size:10px; z-index:2;">
            ${imageName}
          </div>
        `;
        
        console.log('ç”»åƒã‚’è¿½åŠ ã—ã¾ã—ãŸ:', imageName);
        
        // ã™ã¹ã¦ã®ãƒ‘ãƒãƒ«ã«ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        const panels = document.querySelectorAll('.panel');
        let allPanelsHaveImages = true;
        
        panels.forEach(panel => {
          if (panel.querySelector('img') === null && 
              (!panel.style.backgroundImage || panel.style.backgroundImage === 'none')) {
            allPanelsHaveImages = false;
          }
        });
        
        // ã™ã¹ã¦ã®ãƒ‘ãƒãƒ«ã«ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€
        if (allPanelsHaveImages) {
          updateStep(3);
        }
      }
      
      // ç”»åƒé©ç”¨ãƒœã‚¿ãƒ³ã®å‡¦ç†
      applyBtn.addEventListener('click', function() {
        const selectedImage = imageSelect.value;
        console.log('ç”»åƒé©ç”¨:', selectedImage);
        
        // æ—¢å­˜ã®ç”»åƒãŒã‚ã‚Œã°å‰Šé™¤
        const existingImages = currentPanel.querySelectorAll('img');
        existingImages.forEach(img => img.remove());
        
        if (selectedImage) {
          // ç”»åƒã‚’ãƒ‘ãƒãƒ«ã«è¿½åŠ 
          addImageToPanel(currentPanel, selectedImage);
        } else {
          // ç”»åƒãªã—ã®å ´åˆ
          currentPanel.style.backgroundImage = 'none';
          currentPanel.style.backgroundColor = '';
          currentPanel.innerHTML = '';
        }
      });
      
      // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
      resetBtn.addEventListener('click', function() {
        const panels = document.querySelectorAll('.panel');
        panels.forEach(panel => {
          // å†…å®¹ã‚’ã‚¯ãƒªã‚¢
          panel.innerHTML = '';
          // èƒŒæ™¯ç”»åƒã‚‚ã‚¯ãƒªã‚¢
          panel.style.backgroundImage = 'none';
          
          // å°å½¢ãƒ‘ãƒãƒ«ã®å ´åˆã¯è–„ã„è‰²ã‚’è¨­å®š
          if (panel.style.clipPath && panel.style.clipPath !== 'none') {
            panel.style.backgroundColor = '#e8eaf6';
          } else {
            // é€šå¸¸ã®ãƒ‘ãƒãƒ«ã«ã¯è–„ã„è‰²ã‚’è¨­å®š
            panel.style.backgroundColor = '#f5f5f5';
          }
          
          // é¸æŠçŠ¶æ…‹ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’ç¶­æŒ
          if (panel.classList.contains('selected')) {
            panel.style.border = '2px dashed #ff0000';
          } else {
            panel.style.border = '1px solid #000';
          }
        });
        
        imageSelect.value = '';
        updateStep(2); // ã‚¹ãƒ†ãƒƒãƒ—ã‚’2ã«æˆ»ã™
      });
      
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
      const previewImages = document.querySelectorAll('.preview-image');
      previewImages.forEach(img => {
        img.addEventListener('click', function() {
          const imageName = this.dataset.image;
          console.log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚¯ãƒªãƒƒã‚¯:', imageName);
          
          // ç”»åƒã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å€¤ã‚’æ›´æ–°
          imageSelect.value = imageName;
          
          if (currentPanel) {
            // ç”»åƒã‚’ãƒ‘ãƒãƒ«ã«è¿½åŠ 
            addImageToPanel(currentPanel, imageName);
          }
        });
      });
      
      // SVGä¿å­˜ãƒœã‚¿ãƒ³ã®å‡¦ç†
      exportBtn.addEventListener('click', function() {
        try {
          // ç¾åœ¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæƒ…å ±ã‚’å–å¾—
          const templateInfo = currentTemplate || {
            title: 'æ¼«ç”»',
            panels: []
          };
          
          // ç”»åƒã‚’Base64ã«å¤‰æ›ã™ã‚‹é–¢æ•°
          const imageToBase64 = async (url) => {
            return new Promise((resolve, reject) => {
              try {
                // æ—¢ã«ãƒ‡ãƒ¼ã‚¿URLãªã‚‰ãã®ã¾ã¾è¿”ã™
                if (url.startsWith('data:')) {
                  resolve(url);
                  return;
                }
                
                // æ–°ã—ã„ç”»åƒè¦ç´ ã‚’ä½œæˆã—ã¦èª­ã¿è¾¼ã¿
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                  try {
                    // ä¸€æ™‚çš„ãªã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆã—ã¦ç”»åƒã‚’æç”»
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // Base64ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¿”ã™
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                  } catch (e) {
                    console.error('ç”»åƒã®Base64å¤‰æ›ã«å¤±æ•—:', e);
                    // å¤±æ•—ã—ãŸå ´åˆã¯å…ƒã®URLã‚’è¿”ã™
                    resolve(url);
                  }
                };
                
                img.onerror = () => {
                  console.warn('Failed to load image:', url);
                  // å¤±æ•—ã—ãŸå ´åˆã¯å…ƒã®URLã‚’è¿”ã™
                  resolve(url);
                };
                
                // HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®éš›ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
                img.src = url + (url.includes('?') ? '&' : '?') + 'nocache=' + Date.now();
              } catch (e) {
                console.error('Base64å¤‰æ›ã‚¨ãƒ©ãƒ¼:', e);
                resolve(url);
              }
            });
          };
          
          // SVGã§ã‚³ãƒå‰²ã‚Šã‚’å®Œå…¨ã«å†ç¾
          const svgNS = "http://www.w3.org/2000/svg";
          const xlinkNS = "http://www.w3.org/1999/xlink";
          
          // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºè¨­å®š
          const CANVAS_SIZE = 1000;
          
          // SVGè¦ç´ ã‚’ä½œæˆ
          const svg = document.createElementNS(svgNS, "svg");
          svg.setAttribute("xmlns", svgNS);
          svg.setAttribute("xmlns:xlink", xlinkNS);
          svg.setAttribute("width", CANVAS_SIZE);
          svg.setAttribute("height", CANVAS_SIZE);
          svg.setAttribute("viewBox", "0 0 100 100");
          svg.style.backgroundColor = "white";
          
          // èƒŒæ™¯ã®ç™½ã„çŸ©å½¢ã‚’è¿½åŠ 
          const background = document.createElementNS(svgNS, "rect");
          background.setAttribute("x", "0");
          background.setAttribute("y", "0");
          background.setAttribute("width", "100");
          background.setAttribute("height", "100");
          background.setAttribute("fill", "white");
          svg.appendChild(background);
          
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
          const loadingOverlay = document.getElementById('loading-overlay');
          loadingOverlay.style.display = 'flex';
          const loadingText = loadingOverlay.querySelector('.loading-text');
          const processStatus = loadingOverlay.querySelector('.process-status');
          
          loadingText.textContent = 'Generating SVG...';
          processStatus.textContent = 'Converting images to Base64...';
          
          // éåŒæœŸã§ç”»åƒå¤‰æ›ã¨SVGç”Ÿæˆã‚’è¡Œã†
          (async () => {
            const imgProcessPromises = [];
            const allPanels = document.querySelectorAll('.panel');
            const imageUrlMap = new Map(); // ç”»åƒURLã¨Base64ã®ãƒãƒƒãƒ”ãƒ³ã‚°
            
            // å…ˆã«å…¨ã¦ã®ç”»åƒã‚’Base64ã«å¤‰æ›
            for (const panel of allPanels) {
              const img = panel.querySelector('img');
              if (img && img.src) {
                // åŒã˜URLã¯å‡¦ç†ã—ãªã„
                if (!imageUrlMap.has(img.src)) {
                  imgProcessPromises.push(
                    imageToBase64(img.src).then(base64 => {
                      imageUrlMap.set(img.src, base64);
                      console.log(`ç”»åƒå¤‰æ›å®Œäº†: ${img.src.substring(0, 50)}...`);
                    })
                  );
                }
              }
            }
            
            // å…¨ã¦ã®ç”»åƒå¤‰æ›ã‚’å¾…ã¤
            await Promise.all(imgProcessPromises);
            processStatus.textContent = 'Creating SVG panels...';
            
            // ãƒ‘ãƒãƒ«æƒ…å ±ã‚’ä½¿ã£ã¦SVGä½œæˆ
            if (currentTemplate && currentTemplate.panels) {
              currentTemplate.panels.forEach(panelInfo => {
                const panel = document.getElementById(panelInfo.id);
                if (!panel) return;
                
                // ãƒ‘ãƒãƒ«ç”¨ã®ã‚°ãƒ«ãƒ¼ãƒ—è¦ç´ 
                const g = document.createElementNS(svgNS, "g");
                
                // å°å½¢ã®å ´åˆã®ç‰¹æ®Šå‡¦ç†
                if (panelInfo.clipPath) {
                  // å¤šè§’å½¢ç”¨ã®ãƒãƒªã‚´ãƒ³è¦ç´ ã‚’ä½œæˆ
                  const polygon = document.createElementNS(svgNS, "polygon");
                  
                  // clipPathã‹ã‚‰ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ã‚’æŠ½å‡º
                  const clipPathValue = panelInfo.clipPath.replace("polygon(", "").replace(")", "");
                  const points = [];
                  
                  clipPathValue.split(",").forEach(point => {
                    const trimmedPoint = point.trim();
                    const parts = trimmedPoint.split(" ");
                    const x = parseFloat(parts[0]) * panelInfo.width / 100 + panelInfo.left;
                    const y = parseFloat(parts[1]) * panelInfo.height / 100 + panelInfo.top;
                    points.push(`${x},${y}`);
                  });
                  
                  polygon.setAttribute("points", points.join(" "));
                  polygon.setAttribute("fill", "white");
                  polygon.setAttribute("stroke", "black");
                  polygon.setAttribute("stroke-width", "0.2");
                  g.appendChild(polygon);
                  
                  // ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ãƒ‘ã‚¹å®šç¾©
                  const clipPathId = `clip_${panelInfo.id}`;
                  const clipPathElement = document.createElementNS(svgNS, "clipPath");
                  clipPathElement.setAttribute("id", clipPathId);
                  
                  const clipPathPolygon = document.createElementNS(svgNS, "polygon");
                  clipPathPolygon.setAttribute("points", points.join(" "));
                  clipPathElement.appendChild(clipPathPolygon);
                  svg.appendChild(clipPathElement);
                  
                  // ç”»åƒè¦ç´ 
                  const img = panel.querySelector('img');
                  if (img) {
                    const svgImage = document.createElementNS(svgNS, "image");
                    // Base64ã«å¤‰æ›æ¸ˆã¿ã®ç”»åƒURLã‚’ä½¿ç”¨
                    const imageDataUrl = imageUrlMap.get(img.src) || img.src;
                    svgImage.setAttributeNS(xlinkNS, "href", imageDataUrl);
                    svgImage.setAttribute("x", panelInfo.left);
                    svgImage.setAttribute("y", panelInfo.top);
                    svgImage.setAttribute("width", panelInfo.width);
                    svgImage.setAttribute("height", panelInfo.height);
                    svgImage.setAttribute("preserveAspectRatio", "xMidYMid slice");
                    svgImage.setAttribute("clip-path", `url(#${clipPathId})`);
                    g.appendChild(svgImage);
                  }
                } else {
                  // é€šå¸¸ã®çŸ©å½¢ãƒ‘ãƒãƒ«
                  const rect = document.createElementNS(svgNS, "rect");
                  rect.setAttribute("x", panelInfo.left);
                  rect.setAttribute("y", panelInfo.top);
                  rect.setAttribute("width", panelInfo.width);
                  rect.setAttribute("height", panelInfo.height);
                  rect.setAttribute("fill", "white");
                  rect.setAttribute("stroke", "black");
                  rect.setAttribute("stroke-width", "0.2");
                  g.appendChild(rect);
                  
                  // ç”»åƒã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°ãƒ‘ã‚¹
                  const clipPathId = `clip_${panelInfo.id}`;
                  const clipPathElement = document.createElementNS(svgNS, "clipPath");
                  clipPathElement.setAttribute("id", clipPathId);
                  
                  const clipPathRect = document.createElementNS(svgNS, "rect");
                  clipPathRect.setAttribute("x", panelInfo.left);
                  clipPathRect.setAttribute("y", panelInfo.top);
                  clipPathRect.setAttribute("width", panelInfo.width);
                  clipPathRect.setAttribute("height", panelInfo.height);
                  clipPathElement.appendChild(clipPathRect);
                  svg.appendChild(clipPathElement);
                  
                  // ç”»åƒè¦ç´ 
                  const img = panel.querySelector('img');
                  if (img) {
                    const svgImage = document.createElementNS(svgNS, "image");
                    // Base64ã«å¤‰æ›æ¸ˆã¿ã®ç”»åƒURLã‚’ä½¿ç”¨
                    const imageDataUrl = imageUrlMap.get(img.src) || img.src;
                    svgImage.setAttributeNS(xlinkNS, "href", imageDataUrl);
                    svgImage.setAttribute("x", panelInfo.left);
                    svgImage.setAttribute("y", panelInfo.top);
                    svgImage.setAttribute("width", panelInfo.width);
                    svgImage.setAttribute("height", panelInfo.height);
                    svgImage.setAttribute("preserveAspectRatio", "xMidYMid slice");
                    svgImage.setAttribute("clip-path", `url(#${clipPathId})`);
                    g.appendChild(svgImage);
                  }
                }
                
                svg.appendChild(g);
              });
            }
            
            processStatus.textContent = 'SVG generation complete';
            
            // SVGã‚’æ–‡å­—åˆ—ã«å¤‰æ›
            const svgData = new XMLSerializer().serializeToString(svg);
            
            // SVGãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å·¦ä¸Šã«è¡¨ç¤º
            const imgTest = document.createElement('div');
            imgTest.setAttribute('style', 'position:fixed; top:10px; left:10px; width:auto; padding:10px; z-index:9999; border:2px solid red; background:white; border-radius:5px; box-shadow:0 2px 10px rgba(0,0,0,0.2);');
            
            // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ–¹æ³•ã‚’å¤‰æ›´ï¼ˆXMLã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚‚é©åˆ‡ã«å‡¦ç†ï¼‰
            const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
            const svgUrl = URL.createObjectURL(svgBlob);
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `${templateInfo.title}-${timestamp}.svg`;
            
            imgTest.innerHTML = `
              <p style="margin:0 0 10px 0; font-size:14px;">SVG Preview (Correct SVG)</p>
              <img src="${svgUrl}" style="width:500px; height:500px; display:block; margin-bottom:10px; border:1px solid #ccc;" />
              <div style="display:flex; justify-content:space-between;">
                <button id="download-svg-preview" style="padding:8px 15px; background:#4CAF50; color:white; border:none; border-radius:3px; cursor:pointer; font-weight:bold;">Download this SVG</button>
                <button id="close-svg-preview" style="padding:8px 15px; background:#f44336; color:white; border:none; border-radius:3px; cursor:pointer;">Close</button>
              </div>
            `;
            
            document.body.appendChild(imgTest);
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
            loadingOverlay.style.display = 'none';
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('download-svg-preview').addEventListener('click', function() {
              try {
                // Blobã‚’ä½¿ç”¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.download = filename;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // URLã‚’è§£æ”¾
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                console.log('SVG file saved');
              } catch (error) {
                console.error('Error during SVG download:', error);
                alert('Failed to download SVG: ' + error.message);
              }
            });
            
            // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('close-svg-preview').addEventListener('click', function() {
              document.body.removeChild(imgTest);
              // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã®è§£æ”¾
              URL.revokeObjectURL(svgUrl);
            });
          })();
          
        } catch (error) {
          console.error('Error generating SVG:', error);
          alert('Error generating SVG: ' + error.message);
          
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
          const loadingOverlay = document.getElementById('loading-overlay');
          if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
          }
        }
      });
      
      // è¿½åŠ ã®SVGå‡ºåŠ›ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      if (document.getElementById('export-svg-btn')) {
        document.getElementById('export-svg-btn').style.display = 'none';
      }
    });
  </script>
</body>
</html>